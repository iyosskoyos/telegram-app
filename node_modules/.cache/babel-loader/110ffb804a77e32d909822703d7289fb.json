{"ast":null,"code":"import _regeneratorRuntime from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _possibleConstructorReturn from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";import _inherits from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/inherits\";/*\n *  Copyright (c) 2018-present, Evgeny Nadymov\n *\n * This source code is licensed under the GPL v.3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */import React from'react';import classNames from'classnames';import{compose}from'recompose';import withStyles from'@material-ui/core/styles/withStyles';import{withTranslation}from'react-i18next';import CloseIcon from'@material-ui/icons/Close';import ChevronLeftIcon from'@material-ui/icons/ChevronLeft';import ExpandLessIcon from'@material-ui/icons/ExpandLess';import Article from'./Article';import InstantViewMediaViewer from'../Viewer/InstantViewMediaViewer';import IVContext from'./IVContext';import MediaViewerButton from'../Viewer/MediaViewerButton';import{openInstantView}from'../../Actions/InstantView';import{setInstantViewContent,setInstantViewViewerContent}from'../../Actions/Client';import{IV_PHOTO_SIZE}from'../../Constants';import InstantViewStore from'../../Stores/InstantViewStore';import TdLibController from'../../Controllers/TdLibController';import'./InstantViewer.css';import{itemsInView,throttle}from'../../Utils/Common';import{getInnerBlocks}from'../../Utils/InstantView';var styles=function styles(theme){return{instantViewer:{background:theme.palette.type==='dark'?theme.palette.background.default:'#FFFFFF',color:theme.palette.text.primary},leftButton:{color:theme.palette.text.secondary,position:'fixed',top:0,left:0,bottom:0},closeButton:{color:theme.palette.text.secondary,position:'fixed',top:0,right:0}};};var InstantViewer=/*#__PURE__*/function(_React$Component){_inherits(InstantViewer,_React$Component);function InstantViewer(props){var _this;_classCallCheck(this,InstantViewer);_this=_possibleConstructorReturn(this,_getPrototypeOf(InstantViewer).call(this,props));_this.onClientUpdateInstantViewViewerContent=function(update){var content=update.content;if(!content){_this.setState({media:null,caption:null,url:null});return;}var media=content.media,caption=content.caption,url=content.url,instantView=content.instantView;if(_this.props.instantView!==instantView)return;_this.setState({media:media,caption:caption,url:url});};_this.onClientUpdateInstantViewUrl=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(update){var url,active,instantView,hash;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:console.log('[IV] clientUpdateInstantViewUrl',update);url=update.url;active=InstantViewStore.getCurrent();instantView=_this.props.instantView;if(!(active!==instantView)){_context.next=6;break;}return _context.abrupt(\"return\");case 6:if(!(instantView&&url.startsWith(instantView.url))){_context.next=15;break;}hash=new URL(url).hash;if(!(url.indexOf('#')===url.length-1)){_context.next=13;break;}_this.scrollTop('smooth');return _context.abrupt(\"return\");case 13:if(!(hash&&_this.scrollToHash(hash,'smooth'))){_context.next=15;break;}return _context.abrupt(\"return\");case 15:openInstantView(url);case 16:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}();_this.onKeyDown=function(event){if(event.keyCode===27){var media=_this.state.media;if(media){setInstantViewViewerContent(null);return;}_this.handleClose();}};_this.handleBack=function(){var _this$state=_this.state,hasPrev=_this$state.hasPrev,hasScroll=_this$state.hasScroll;if(hasScroll){_this.scrollTop('smooth');return;}if(hasPrev){TdLibController.clientUpdate({'@type':'clientUpdatePrevInstantView'});return;}_this.handleClose();};_this.handleScroll=function(){var element=_this.instantViewerRef.current;_this.setState({hasScroll:element.scrollTop>50});_this.updateItemsInView();};_this.articleRef=React.createRef();_this.instantViewerRef=React.createRef();_this.state={};_this.updateItemsInView=throttle(_this.updateItemsInView,500);return _this;}_createClass(InstantViewer,[{key:\"shouldComponentUpdate\",value:function shouldComponentUpdate(nextProps,nextState,nextContext){var instantView=this.props.instantView;var _this$state2=this.state,hasScroll=_this$state2.hasScroll,hasPrev=_this$state2.hasPrev,media=_this$state2.media,caption=_this$state2.caption,url=_this$state2.url;if(instantView!==nextProps.instantView){return true;}if(hasScroll!==nextState.hasScroll){return true;}if(hasPrev!==nextState.hasPrev){return true;}if(media!==nextState.media){return true;}if(caption!==nextState.caption){return true;}if(url!==nextState.url){return true;}return false;}},{key:\"componentDidMount\",value:function componentDidMount(){this.mounted=true;this.handleScroll();document.addEventListener('keydown',this.onKeyDown,false);InstantViewStore.on('clientUpdateInstantViewUrl',this.onClientUpdateInstantViewUrl);InstantViewStore.on('clientUpdateInstantViewViewerContent',this.onClientUpdateInstantViewViewerContent);}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){this.mounted=false;document.removeEventListener('keydown',this.onKeyDown,false);InstantViewStore.removeListener('clientUpdateInstantViewUrl',this.onClientUpdateInstantViewUrl);InstantViewStore.removeListener('clientUpdateInstantViewViewerContent',this.onClientUpdateInstantViewViewerContent);}},{key:\"scrollToHash\",value:function scrollToHash(hash,behavior){if(!hash)return false;var hiddenElement=document.getElementById(hash.substr(1));if(hiddenElement){var details=[];var finished=false;var currentElement=hiddenElement;do{currentElement=currentElement.parentNode;if(currentElement){if(currentElement.nodeName==='DETAILS'){details.push(currentElement);}else if(currentElement.nodeName==='ARTICLE'){finished=true;}}else{finished=true;}}while(!finished);details.forEach(function(x){return x.open=true;});hiddenElement.scrollIntoView({block:'center',behavior:behavior});return true;}return false;}},{key:\"scrollTop\",value:function scrollTop(behavior){var element=this.instantViewerRef.current;switch(behavior){case'smooth':{element.scrollTop=Math.min(element.scrollTop,100);setTimeout(function(){element.scrollTo({top:0,behavior:'smooth'});},50);break;}default:{element.scrollTo({top:0,behavior:behavior});}}}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps,prevState,snapshot){var _this$props=this.props,instantView=_this$props.instantView,url=_this$props.url;console.log('[IV] componentDidUpdate',instantView.url,instantView.url===prevProps.instantView.url);var hash=new URL(instantView.url).hash;if(prevProps.instantView!==instantView){if(prevProps.instantView.url!==instantView.url){if(instantView.url.indexOf('#')===instantView.url.length-1){console.log('[IV] componentDidUpdate scrollTop auto');this.scrollTop('auto');}else if(hash){console.log('[IV] componentDidUpdate scrollToHash',hash);this.scrollToHash(hash,'auto');}else{console.log('[IV] componentDidUpdate scrollTop auto');this.scrollTop('auto');}}else{if(hash){console.log('[IV] componentDidUpdate scrollToHash',hash);this.scrollToHash(hash,'auto');}else{console.log('[IV] componentDidUpdate scrollTop smooth');this.scrollTop('smooth');}}this.handleScroll();}}},{key:\"handleClose\",value:function handleClose(){setInstantViewContent(null);}},{key:\"updateItemsInView\",value:function updateItemsInView(){if(!this.mounted)return;var instantView=this.props.instantView;if(!instantView)return;var page_blocks=instantView.page_blocks;var blocks=new Map();var items=itemsInView(this.instantViewerRef,this.articleRef);for(var i=0;i<items.length;i++){var block=page_blocks[items[i]];blocks.set(block,block);var innerBlocks=getInnerBlocks(block);innerBlocks.forEach(function(x){return blocks.set(x,x);});}TdLibController.clientUpdate({'@type':'clientUpdateBlocksInView',blocks:blocks});}},{key:\"render\",value:function render(){var _this$props2=this.props,classes=_this$props2.classes,instantView=_this$props2.instantView;var _this$state3=this.state,hasPrev=_this$state3.hasPrev,hasScroll=_this$state3.hasScroll,media=_this$state3.media,caption=_this$state3.caption,url=_this$state3.url;if(!instantView)return null;return React.createElement(IVContext.Provider,{value:instantView},React.createElement(\"div\",{ref:this.instantViewerRef,className:classNames('instant-viewer',classes.instantViewer),onScroll:this.handleScroll},React.createElement(\"div\",{className:\"instant-viewer-left-column\",onClick:this.handleBack},React.createElement(MediaViewerButton,{className:classes.leftButton,style:{alignItems:'flex-start'},onClick:this.handleBack},hasScroll?React.createElement(ExpandLessIcon,{className:\"media-viewer-button-icon\",fontSize:\"large\"}):React.createElement(ChevronLeftIcon,{className:\"media-viewer-button-icon\",fontSize:\"large\"}))),React.createElement(\"div\",{className:\"instant-viewer-content-column\"},React.createElement(\"div\",null,React.createElement(Article,{ref:this.articleRef}))),React.createElement(\"div\",{className:\"instant-viewer-right-column\"},React.createElement(MediaViewerButton,{className:classes.closeButton,onClick:this.handleClose},React.createElement(CloseIcon,{className:\"media-viewer-button-icon\",fontSize:\"large\"})))),media&&React.createElement(InstantViewMediaViewer,{media:media,size:IV_PHOTO_SIZE,caption:caption,url:url}));}}],[{key:\"getDerivedStateFromProps\",value:function getDerivedStateFromProps(props,state){if(props.instantView!==state.prevInstantView){return{prevInstantView:props.instantView,hasPrev:InstantViewStore.hasPrev(),hasScroll:false,media:null,caption:null,url:null};}return null;}}]);return InstantViewer;}(React.Component);var enhance=compose(withStyles(styles),withTranslation());export default enhance(InstantViewer);","map":{"version":3,"sources":["/Users/yosuahalim/Documents/Projects/telegram-app/src/Components/InstantView/InstantViewer.js"],"names":["React","classNames","compose","withStyles","withTranslation","CloseIcon","ChevronLeftIcon","ExpandLessIcon","Article","InstantViewMediaViewer","IVContext","MediaViewerButton","openInstantView","setInstantViewContent","setInstantViewViewerContent","IV_PHOTO_SIZE","InstantViewStore","TdLibController","itemsInView","throttle","getInnerBlocks","styles","theme","instantViewer","background","palette","type","default","color","text","primary","leftButton","secondary","position","top","left","bottom","closeButton","right","InstantViewer","props","onClientUpdateInstantViewViewerContent","update","content","setState","media","caption","url","instantView","onClientUpdateInstantViewUrl","console","log","active","getCurrent","startsWith","hash","URL","indexOf","length","scrollTop","scrollToHash","onKeyDown","event","keyCode","state","handleClose","handleBack","hasPrev","hasScroll","clientUpdate","handleScroll","element","instantViewerRef","current","updateItemsInView","articleRef","createRef","nextProps","nextState","nextContext","mounted","document","addEventListener","on","removeEventListener","removeListener","behavior","hiddenElement","getElementById","substr","details","finished","currentElement","parentNode","nodeName","push","forEach","x","open","scrollIntoView","block","Math","min","setTimeout","scrollTo","prevProps","prevState","snapshot","page_blocks","blocks","Map","items","i","set","innerBlocks","classes","alignItems","prevInstantView","Component","enhance"],"mappings":"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","sourcesContent":["/*\n *  Copyright (c) 2018-present, Evgeny Nadymov\n *\n * This source code is licensed under the GPL v.3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport classNames from 'classnames';\nimport { compose } from 'recompose';\nimport withStyles from '@material-ui/core/styles/withStyles';\nimport { withTranslation } from 'react-i18next';\nimport CloseIcon from '@material-ui/icons/Close';\nimport ChevronLeftIcon from '@material-ui/icons/ChevronLeft';\nimport ExpandLessIcon from '@material-ui/icons/ExpandLess';\nimport Article from './Article';\nimport InstantViewMediaViewer from '../Viewer/InstantViewMediaViewer';\nimport IVContext from './IVContext';\nimport MediaViewerButton from '../Viewer/MediaViewerButton';\nimport { openInstantView } from '../../Actions/InstantView';\nimport { setInstantViewContent, setInstantViewViewerContent } from '../../Actions/Client';\nimport { IV_PHOTO_SIZE } from '../../Constants';\nimport InstantViewStore from '../../Stores/InstantViewStore';\nimport TdLibController from '../../Controllers/TdLibController';\nimport './InstantViewer.css';\nimport { itemsInView, throttle } from '../../Utils/Common';\nimport { getInnerBlocks } from '../../Utils/InstantView';\n\nconst styles = theme => ({\n    instantViewer: {\n        background: theme.palette.type === 'dark' ? theme.palette.background.default : '#FFFFFF',\n        color: theme.palette.text.primary\n    },\n    leftButton: {\n        color: theme.palette.text.secondary,\n        position: 'fixed',\n        top: 0,\n        left: 0,\n        bottom: 0\n    },\n    closeButton: {\n        color: theme.palette.text.secondary,\n        position: 'fixed',\n        top: 0,\n        right: 0\n    }\n});\n\nclass InstantViewer extends React.Component {\n    constructor(props) {\n        super(props);\n\n        this.articleRef = React.createRef();\n        this.instantViewerRef = React.createRef();\n\n        this.state = {};\n\n        this.updateItemsInView = throttle(this.updateItemsInView, 500);\n    }\n\n    static getDerivedStateFromProps(props, state) {\n        if (props.instantView !== state.prevInstantView) {\n            return {\n                prevInstantView: props.instantView,\n                hasPrev: InstantViewStore.hasPrev(),\n                hasScroll: false,\n                media: null,\n                caption: null,\n                url: null\n            };\n        }\n\n        return null;\n    }\n\n    shouldComponentUpdate(nextProps, nextState, nextContext) {\n        const { instantView } = this.props;\n        const { hasScroll, hasPrev, media, caption, url } = this.state;\n\n        if (instantView !== nextProps.instantView) {\n            return true;\n        }\n\n        if (hasScroll !== nextState.hasScroll) {\n            return true;\n        }\n\n        if (hasPrev !== nextState.hasPrev) {\n            return true;\n        }\n\n        if (media !== nextState.media) {\n            return true;\n        }\n\n        if (caption !== nextState.caption) {\n            return true;\n        }\n\n        if (url !== nextState.url) {\n            return true;\n        }\n\n        return false;\n    }\n\n    componentDidMount() {\n        this.mounted = true;\n        this.handleScroll();\n\n        document.addEventListener('keydown', this.onKeyDown, false);\n        InstantViewStore.on('clientUpdateInstantViewUrl', this.onClientUpdateInstantViewUrl);\n        InstantViewStore.on('clientUpdateInstantViewViewerContent', this.onClientUpdateInstantViewViewerContent);\n    }\n\n    componentWillUnmount() {\n        this.mounted = false;\n        document.removeEventListener('keydown', this.onKeyDown, false);\n        InstantViewStore.removeListener('clientUpdateInstantViewUrl', this.onClientUpdateInstantViewUrl);\n        InstantViewStore.removeListener(\n            'clientUpdateInstantViewViewerContent',\n            this.onClientUpdateInstantViewViewerContent\n        );\n    }\n\n    onClientUpdateInstantViewViewerContent = update => {\n        const { content } = update;\n        if (!content) {\n            this.setState({ media: null, caption: null, url: null });\n            return;\n        }\n\n        const { media, caption, url, instantView } = content;\n\n        if (this.props.instantView !== instantView) return;\n\n        this.setState({ media, caption, url });\n    };\n\n    onClientUpdateInstantViewUrl = async update => {\n        console.log('[IV] clientUpdateInstantViewUrl', update);\n        const { url } = update;\n        const active = InstantViewStore.getCurrent();\n        const { instantView } = this.props;\n\n        if (active !== instantView) return;\n\n        if (instantView && url.startsWith(instantView.url)) {\n            const hash = new URL(url).hash;\n            if (url.indexOf('#') === url.length - 1) {\n                this.scrollTop('smooth');\n\n                return;\n            } else if (hash && this.scrollToHash(hash, 'smooth')) {\n                return;\n            }\n        }\n\n        openInstantView(url);\n    };\n\n    scrollToHash(hash, behavior) {\n        if (!hash) return false;\n\n        const hiddenElement = document.getElementById(hash.substr(1));\n        if (hiddenElement) {\n            const details = [];\n            let finished = false;\n            let currentElement = hiddenElement;\n            do {\n                currentElement = currentElement.parentNode;\n                if (currentElement) {\n                    if (currentElement.nodeName === 'DETAILS') {\n                        details.push(currentElement);\n                    } else if (currentElement.nodeName === 'ARTICLE') {\n                        finished = true;\n                    }\n                } else {\n                    finished = true;\n                }\n            } while (!finished);\n\n            details.forEach(x => (x.open = true));\n\n            hiddenElement.scrollIntoView({\n                block: 'center',\n                behavior\n            });\n\n            return true;\n        }\n\n        return false;\n    }\n\n    scrollTop(behavior) {\n        const element = this.instantViewerRef.current;\n\n        switch (behavior) {\n            case 'smooth': {\n                element.scrollTop = Math.min(element.scrollTop, 100);\n                setTimeout(() => {\n                    element.scrollTo({\n                        top: 0,\n                        behavior: 'smooth'\n                    });\n                }, 50);\n                break;\n            }\n            default: {\n                element.scrollTo({\n                    top: 0,\n                    behavior\n                });\n            }\n        }\n    }\n\n    componentDidUpdate(prevProps, prevState, snapshot) {\n        const { instantView, url } = this.props;\n        console.log('[IV] componentDidUpdate', instantView.url, instantView.url === prevProps.instantView.url);\n\n        const hash = new URL(instantView.url).hash;\n        if (prevProps.instantView !== instantView) {\n            if (prevProps.instantView.url !== instantView.url) {\n                if (instantView.url.indexOf('#') === instantView.url.length - 1) {\n                    console.log('[IV] componentDidUpdate scrollTop auto');\n                    this.scrollTop('auto');\n                } else if (hash) {\n                    console.log('[IV] componentDidUpdate scrollToHash', hash);\n                    this.scrollToHash(hash, 'auto');\n                } else {\n                    console.log('[IV] componentDidUpdate scrollTop auto');\n                    this.scrollTop('auto');\n                }\n            } else {\n                if (hash) {\n                    console.log('[IV] componentDidUpdate scrollToHash', hash);\n                    this.scrollToHash(hash, 'auto');\n                } else {\n                    console.log('[IV] componentDidUpdate scrollTop smooth');\n                    this.scrollTop('smooth');\n                }\n            }\n\n            this.handleScroll();\n        }\n    }\n\n    onKeyDown = event => {\n        if (event.keyCode === 27) {\n            const { media } = this.state;\n\n            if (media) {\n                setInstantViewViewerContent(null);\n                return;\n            }\n\n            this.handleClose();\n        }\n    };\n\n    handleClose() {\n        setInstantViewContent(null);\n    }\n\n    handleBack = () => {\n        const { hasPrev, hasScroll } = this.state;\n        if (hasScroll) {\n            this.scrollTop('smooth');\n            return;\n        }\n\n        if (hasPrev) {\n            TdLibController.clientUpdate({\n                '@type': 'clientUpdatePrevInstantView'\n            });\n            return;\n        }\n\n        this.handleClose();\n    };\n\n    handleScroll = () => {\n        const element = this.instantViewerRef.current;\n        this.setState({\n            hasScroll: element.scrollTop > 50\n        });\n\n        this.updateItemsInView();\n    };\n\n    updateItemsInView() {\n        if (!this.mounted) return;\n\n        const { instantView } = this.props;\n        if (!instantView) return;\n\n        const { page_blocks } = instantView;\n\n        const blocks = new Map();\n        const items = itemsInView(this.instantViewerRef, this.articleRef);\n\n        for (let i = 0; i < items.length; i++) {\n            const block = page_blocks[items[i]];\n            blocks.set(block, block);\n\n            const innerBlocks = getInnerBlocks(block);\n            innerBlocks.forEach(x => blocks.set(x, x));\n        }\n\n        TdLibController.clientUpdate({\n            '@type': 'clientUpdateBlocksInView',\n            blocks\n        });\n    }\n\n    render() {\n        const { classes, instantView } = this.props;\n        const { hasPrev, hasScroll, media, caption, url } = this.state;\n        if (!instantView) return null;\n\n        return (\n            <IVContext.Provider value={instantView}>\n                <div\n                    ref={this.instantViewerRef}\n                    className={classNames('instant-viewer', classes.instantViewer)}\n                    onScroll={this.handleScroll}>\n                    <div className='instant-viewer-left-column' onClick={this.handleBack}>\n                        <MediaViewerButton\n                            className={classes.leftButton}\n                            style={{ alignItems: 'flex-start' }}\n                            onClick={this.handleBack}>\n                            {hasScroll ? (\n                                <ExpandLessIcon className='media-viewer-button-icon' fontSize='large' />\n                            ) : (\n                                <ChevronLeftIcon className='media-viewer-button-icon' fontSize='large' />\n                            )}\n                        </MediaViewerButton>\n                    </div>\n                    <div className='instant-viewer-content-column'>\n                        <div>\n                            <Article ref={this.articleRef} />\n                        </div>\n                    </div>\n                    <div className='instant-viewer-right-column'>\n                        <MediaViewerButton className={classes.closeButton} onClick={this.handleClose}>\n                            <CloseIcon className='media-viewer-button-icon' fontSize='large' />\n                        </MediaViewerButton>\n                    </div>\n                </div>\n                {media && <InstantViewMediaViewer media={media} size={IV_PHOTO_SIZE} caption={caption} url={url} />}\n            </IVContext.Provider>\n        );\n    }\n}\n\nInstantViewer.propTypes = {\n    instantView: PropTypes.object.isRequired\n};\n\nconst enhance = compose(\n    withStyles(styles),\n    withTranslation()\n);\n\nexport default enhance(InstantViewer);\n"]},"metadata":{},"sourceType":"module"}