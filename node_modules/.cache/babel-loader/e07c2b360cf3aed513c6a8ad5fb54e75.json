{"ast":null,"code":"import _regeneratorRuntime from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _possibleConstructorReturn from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";import _inherits from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/helpers/esm/inherits\";/*\n *  Copyright (c) 2018-present, Evgeny Nadymov\n *\n * This source code is licensed under the GPL v.3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */import{EventEmitter}from'events';import{getLocationId}from'../Utils/Message';import{FILE_PRIORITY,IV_LOCATION_HEIGHT,IV_LOCATION_WIDTH,THUMBNAIL_PRIORITY}from'../Constants';import TdLibController from'../Controllers/TdLibController';var useReadFile=true;var useDownloadFile=true;var FileStore=/*#__PURE__*/function(_EventEmitter){_inherits(FileStore,_EventEmitter);function FileStore(){var _this;_classCallCheck(this,FileStore);_this=_possibleConstructorReturn(this,_getPrototypeOf(FileStore).call(this));_this.reset=function(){_this.callbacks=[];//this.transactionCount = 0;\n_this.db=null;_this.urls=new WeakMap();_this.items=new Map();_this.blobItems=new Map();_this.locationItems=new Map();_this.downloads=new Map();_this.uploads=new Map();};_this.onUpdate=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(update){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.t0=update['@type'];_context.next=_context.t0==='updateAuthorizationState'?3:_context.t0==='updateFile'?6:10;break;case 3:_context.next=5;return _this.onUpdateAuthorizationState(update);case 5:return _context.abrupt(\"break\",11);case 6:_this.set(update.file);_this.onUpdateFile(update);_this.emit(update['@type'],update);return _context.abrupt(\"break\",11);case 10:return _context.abrupt(\"break\",11);case 11:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}();_this.onClientUpdate=function(update){switch(update['@type']){case'clientUpdateAudioThumbnailBlob':{_this.emit(update['@type'],update);break;}case'clientUpdateAudioBlob':{_this.emit(update['@type'],update);break;}case'clientUpdateDocumentBlob':{_this.emit(update['@type'],update);break;}default:break;}};_this.addTdLibListener=function(){TdLibController.addListener('update',_this.onUpdate);TdLibController.addListener('clientUpdate',_this.onClientUpdate);};_this.removeTdLibListener=function(){TdLibController.removeListener('update',_this.onUpdate);TdLibController.removeListener('clientUpdate',_this.onClientUpdate);};_this.onUpdateAuthorizationState=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(update){var authorization_state;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(update){_context2.next=2;break;}return _context2.abrupt(\"return\");case 2:authorization_state=update.authorization_state;if(authorization_state){_context2.next=5;break;}return _context2.abrupt(\"return\");case 5:_context2.t0=authorization_state['@type'];_context2.next=_context2.t0==='authorizationStateWaitTdlibParameters'?8:_context2.t0==='authorizationStateClosed'?11:13;break;case 8:_context2.next=10;return _this.initDB();case 10:return _context2.abrupt(\"break\",13);case 11:_this.reset();return _context2.abrupt(\"break\",13);case 13:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x2){return _ref2.apply(this,arguments);};}();_this.onUpdateFile=function(update){if(!update)return;var file=update.file;if(!file)return;_this.handleDownloads(file);_this.handleUploads(file);};_this.handleDownloads=function(file){var arr=file.arr,id=file.id,idb_key=file.idb_key,local=file.local;delete file.arr;if(!_this.downloads.has(id))return;if(!local.is_downloading_completed)return;if(!useReadFile&&!idb_key&&!arr)return;var items=_this.downloads.get(id);if(!items)return;_this.downloads.delete(id);var store=_this.getStore();items.forEach(function(item){switch(item['@type']){case'animation':{_this.handleAnimation(store,item,file,arr,null);break;}case'audio':{_this.handleAudio(store,item,file,arr,null);break;}case'chat':{_this.handleChat(store,item,file,arr);break;}case'document':{_this.handleDocument(store,item,file,arr,null);break;}case'game':{_this.handleGame(store,item,file,arr,null);break;}case'location':{_this.handleLocation(store,item,file,arr,null);break;}case'message':{_this.handleMessage(store,item,file,arr);break;}case'pageBlockMap':{_this.handlePageBlockMap(store,item,file,arr,null);break;}case'photo':{_this.handlePhoto(store,item,file,arr,null);break;}case'sticker':{_this.handleSticker(store,item,file,arr,null);break;}case'video':{_this.handleVideo(store,item,file,arr,null);break;}case'videoNote':{_this.handleVideoNote(store,item,file,arr,null);break;}case'voiceNote':{_this.handleVoiceNote(store,item,file,arr,null);break;}case'user':{_this.handleUser(store,item,file,arr);break;}default:console.error('FileStore.onUpdateFile unhandled item',item);break;}});};_this.handleUploads=function(file){var id=file.id,remote=file.remote;delete file.arr;if(!_this.uploads.has(id))return;if(remote.is_uploading_completed)return;_this.uploads.delete(id);};_this.handleChat=function(store,chat,file,arr){if(!chat)return;_this.getLocalFile(store,file,arr,function(){return _this.updateChatPhotoBlob(chat.id,file.id);},function(){return _this.getRemoteFile(file.id,FILE_PRIORITY,chat);});};_this.handleUser=function(store,user,file,arr){if(!user)return;_this.getLocalFile(store,file,arr,function(){return _this.updateUserPhotoBlob(user.id,file.id);},function(){return _this.getRemoteFile(file.id,FILE_PRIORITY,user);});};_this.handleMessage=function(store,message,file,arr){if(!message)return;var content=message.content;if(!content)return;switch(content['@type']){case'messageAnimation':{var animation=content.animation;_this.handleAnimation(store,animation,file,arr,message);break;}case'messageAudio':{var audio=content.audio;_this.handleAudio(store,audio,file,arr,message);break;}case'messageChatChangePhoto':{var photo=content.photo;_this.handlePhoto(store,photo,file,arr,message);break;}case'messageDocument':{var document=content.document;_this.handleDocument(store,document,file,arr,message);break;}case'messageGame':{var game=content.game;_this.handleGame(store,game,file,arr,message);break;}case'messageLocation':{var location=content.location;_this.handleLocation(store,location,file,arr,message);break;}case'messagePhoto':{var _photo=content.photo;_this.handlePhoto(store,_photo,file,arr,message);break;}case'messageSticker':{var sticker=content.sticker;_this.handleSticker(store,sticker,file,arr,message);break;}case'messageText':{var web_page=content.web_page;if(!web_page)break;var _animation=web_page.animation,_audio=web_page.audio,_document=web_page.document,_photo2=web_page.photo,_sticker=web_page.sticker,video=web_page.video,video_note=web_page.video_note,voice_note=web_page.voice_note;if(_animation){_this.handleAnimation(store,_animation,file,arr,message);}if(_audio){_this.handleAudio(store,_audio,file,arr,message);}if(_document){_this.handleDocument(store,_document,file,arr,message);}if(_photo2){_this.handlePhoto(store,_photo2,file,arr,message);}if(_sticker){_this.handleSticker(store,_sticker,file,arr,message);}if(video){_this.handleVideo(store,video,file,arr,message);}if(voice_note){_this.handleVoiceNote(store,voice_note,file,arr,message);}if(video_note){_this.handleVideoNote(store,video_note,file,arr,message);}break;}case'messageVenue':{var venue=content.venue;var _location=venue.location;_this.handleLocation(store,_location,file,arr,message);break;}case'messageVideo':{var _video=content.video;_this.handleVideo(store,_video,file,arr,message);break;}case'messageVideoNote':{var _video_note=content.video_note;_this.handleVideoNote(store,_video_note,file,arr,message);break;}case'messageVoiceNote':{var _voice_note=content.voice_note;_this.handleVoiceNote(store,_voice_note,file,arr,message);break;}default:break;}};_this.handleAnimation=function(store,animation,file,arr,obj){var chatId=obj?obj.chat_id:0;var messageId=obj?obj.id:0;if(animation.thumbnail){var source=animation.thumbnail.photo;if(source&&source.id===file.id){_this.getLocalFile(store,source,arr,function(){return _this.updateAnimationThumbnailBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,THUMBNAIL_PRIORITY,obj||animation);});}}if(animation.animation){var _source=animation.animation;if(_source&&_source.id===file.id){_this.getLocalFile(store,_source,arr,function(){return _this.updateAnimationBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,FILE_PRIORITY,obj||animation);});}}};_this.handleAudio=function(store,audio,file,arr,obj){var chatId=obj?obj.chat_id:0;var messageId=obj?obj.id:0;if(audio.album_cover_thumbnail){var source=audio.album_cover_thumbnail.photo;if(source&&source.id===file.id){_this.getLocalFile(store,source,arr,function(){return _this.updateAudioThumbnailBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,THUMBNAIL_PRIORITY,obj||audio);});}}if(audio.audio){var _source2=audio.audio;if(_source2&&_source2.id===file.id){_this.getLocalFile(store,_source2,arr,function(){return _this.updateAudioBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,FILE_PRIORITY,obj||audio);});}}};_this.handleGame=function(store,game,file,arr,message){if(!game)return;var animation=game.animation,photo=game.photo;if(photo){_this.handlePhoto(store,photo,file,arr,message);}if(animation){_this.handleAnimation(store,animation,file,arr,message);}};_this.handleDocument=function(store,document,file,arr,obj){var chatId=obj?obj.chat_id:0;var messageId=obj?obj.id:0;if(document.thumbnail){var source=document.thumbnail.photo;if(source&&source.id===file.id){_this.getLocalFile(store,source,arr,function(){return _this.updateDocumentThumbnailBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,THUMBNAIL_PRIORITY,obj||document);});}}if(document.document){var _source3=document.document;if(_source3&&_source3.id===file.id){_this.getLocalFile(store,_source3,arr,function(){return _this.updateDocumentBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,FILE_PRIORITY,obj||document);});}}};_this.handleLocation=function(store,location,file,arr,obj){var chatId=obj?obj.chat_id:0;var messageId=obj?obj.id:0;var locationId=getLocationId(location);if(locationId){var source=_this.getLocationFile(locationId);if(source&&source.id===file.id){_this.getLocalFile(store,source,arr,function(){return _this.updateLocationBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,THUMBNAIL_PRIORITY,obj||location);});}}};_this.handlePageBlockMap=function(store,pageBlockMap,file,arr,obj){var chatId=obj?obj.chat_id:0;var messageId=obj?obj.id:0;var location=pageBlockMap.location;var locationId=getLocationId(location,IV_LOCATION_WIDTH,IV_LOCATION_HEIGHT);if(locationId){var source=_this.getLocationFile(locationId);if(source&&source.id===file.id){_this.getLocalFile(store,source,arr,function(){return _this.updateLocationBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,THUMBNAIL_PRIORITY,obj||pageBlockMap);});}}};_this.handlePhoto=function(store,photo,file,arr,obj){var chatId=obj?obj.chat_id:0;var messageId=obj?obj.id:0;if(photo){for(var i=0;i<photo.sizes.length;i++){var photoSize=photo.sizes[i];if(photoSize){var source=photoSize.photo;if(source&&source.id===file.id){_this.getLocalFile(store,source,arr,function(){return _this.updatePhotoBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,FILE_PRIORITY,obj||photo);});break;}}}}};_this.handleSticker=function(store,sticker,file,arr,obj){var chatId=obj?obj.chat_id:0;var messageId=obj?obj.id:0;if(sticker.thumbnail){var source=sticker.thumbnail.photo;if(source&&source.id===file.id){_this.getLocalFile(store,source,arr,function(){return _this.updateStickerThumbnailBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,THUMBNAIL_PRIORITY,obj||sticker);});}}if(sticker.sticker){var _source4=sticker.sticker;if(_source4&&_source4.id===file.id){_this.getLocalFile(store,_source4,arr,function(){return _this.updateStickerBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,FILE_PRIORITY,obj||sticker);});}}};_this.handleVoiceNote=function(store,voiceNote,file,arr,obj){var chatId=obj?obj.chat_id:0;var messageId=obj?obj.id:0;if(voiceNote.voice){var source=voiceNote.voice;if(source&&source.id===file.id){_this.getLocalFile(store,source,arr,function(){return _this.updateVoiceNoteBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,FILE_PRIORITY,obj||voiceNote);});}}};_this.handleVideoNote=function(store,videoNote,file,arr,obj){var chatId=obj?obj.chat_id:0;var messageId=obj?obj.id:0;if(videoNote.thumbnail){var source=videoNote.thumbnail.photo;if(source&&source.id===file.id){_this.getLocalFile(store,source,arr,function(){return _this.updateVideoNoteThumbnailBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,THUMBNAIL_PRIORITY,obj||videoNote);});}}if(videoNote.video){var _source5=videoNote.video;if(_source5&&_source5.id===file.id){_this.getLocalFile(store,_source5,arr,function(){return _this.updateVideoNoteBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,FILE_PRIORITY,obj||videoNote);});}}};_this.handleVideo=function(store,video,file,arr,obj){var chatId=obj?obj.chat_id:0;var messageId=obj?obj.id:0;if(video.thumbnail){var source=video.thumbnail.photo;if(source&&source.id===file.id){_this.getLocalFile(store,source,arr,function(){return _this.updateVideoThumbnailBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,THUMBNAIL_PRIORITY,obj||video);});}}if(video.video){var _source6=video.video;if(_source6&&_source6.id===file.id){_this.getLocalFile(store,_source6,arr,function(){return _this.updateVideoBlob(chatId,messageId,file.id);},function(){return _this.getRemoteFile(file.id,FILE_PRIORITY,obj||video);});}}};_this.deleteLocalFile=function(store,file){};_this.get=function(fileId){return _this.items.get(fileId);};_this.set=function(file){_this.items.set(file.id,file);};_this.getBlob=function(fileId){return _this.blobItems.get(fileId);};_this.setBlob=function(fileId,blob){_this.blobItems.set(fileId,blob);};_this.deleteBlob=function(fileId){_this.blobItems.delete(fileId);};_this.getLocationFile=function(locationId){var fileId=_this.locationItems.get(locationId);return _this.get(fileId);};_this.setLocationFile=function(locationId,file){_this.locationItems.set(locationId,file.id);_this.set(file);};_this.getBlobUrl=function(blob){if(!blob){return null;}if(_this.urls.has(blob)){return _this.urls.get(blob);}var url=URL.createObjectURL(blob);_this.urls.set(blob,url);return url;};_this.deleteBlobUrl=function(blob){if(_this.urls.has(blob)){_this.urls.delete(blob);}};_this.updatePhotoBlob=function(chatId,messageId,fileId){_this.emit('clientUpdatePhotoBlob',{chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateAudioThumbnailBlob=function(chatId,messageId,fileId){TdLibController.clientUpdate({'@type':'clientUpdateAudioThumbnailBlob',chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateAudioBlob=function(chatId,messageId,fileId){TdLibController.clientUpdate({'@type':'clientUpdateAudioBlob',chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateVoiceNoteBlob=function(chatId,messageId,fileId){_this.emit('clientUpdateVoiceNoteBlob',{chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateVideoNoteThumbnailBlob=function(chatId,messageId,fileId){_this.emit('clientUpdateVideoNoteThumbnailBlob',{chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateVideoNoteBlob=function(chatId,messageId,fileId){_this.emit('clientUpdateVideoNoteBlob',{chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateAnimationThumbnailBlob=function(chatId,messageId,fileId){_this.emit('clientUpdateAnimationThumbnailBlob',{chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateAnimationBlob=function(chatId,messageId,fileId){_this.emit('clientUpdateAnimationBlob',{chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateDocumentBlob=function(chatId,messageId,fileId){TdLibController.clientUpdate({'@type':'clientUpdateDocumentBlob',chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateVideoThumbnailBlob=function(chatId,messageId,fileId){_this.emit('clientUpdateVideoThumbnailBlob',{chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateVideoBlob=function(chatId,messageId,fileId){_this.emit('clientUpdateVideoBlob',{chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateStickerThumbnailBlob=function(chatId,messageId,fileId){_this.emit('clientUpdateStickerThumbnailBlob',{chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateStickerBlob=function(chatId,messageId,fileId){_this.emit('clientUpdateStickerBlob',{chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateLocationBlob=function(chatId,messageId,fileId){_this.emit('clientUpdateLocationBlob',{chatId:chatId,messageId:messageId,fileId:fileId});};_this.updateDocumentThumbnailBlob=function(chatId,messageId,fileId){_this.emit('clientUpdateDocumentThumbnailBlob',{chatId:chatId,messageId:messageId,fileId:fileId});};_this.reset();_this.addTdLibListener();_this.setMaxListeners(Infinity);return _this;}_createClass(FileStore,[{key:\"initDB\",value:function(){var _initDB=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(callback){var i;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!this.db){_context3.next=4;break;}console.log('[FileStore] db exists');if(callback)callback();return _context3.abrupt(\"return\");case 4:if(!this.initiatingDB){_context3.next=8;break;}console.log('[FileStore] add callback');if(callback)this.callbacks.push(callback);return _context3.abrupt(\"return\");case 8:console.log('[FileStore] start initDB');if(callback)this.callbacks.push(callback);this.initiatingDB=true;_context3.next=13;return this.openDB().catch(function(error){return console.log('[FileStore] initDB error',error);});case 13:this.db=_context3.sent;this.initiatingDB=false;console.log('[FileStore] stop initDB');if(this.callbacks.length){console.log('[FileStore] invoke callbacks count='+this.callbacks.length);for(i=0;i<this.callbacks.length;i++){this.callbacks[i]();}this.callbacks=[];}case 17:case\"end\":return _context3.stop();}}},_callee3,this);}));function initDB(_x3){return _initDB.apply(this,arguments);}return initDB;}()},{key:\"openDB\",value:function openDB(){return new Promise(function(resolve,reject){var request=window.indexedDB.open('tdlib');request.onsuccess=function(){return resolve(request.result);};request.onerror=function(){return reject(request.error);};});}},{key:\"getStore\",value:function getStore(){if(useReadFile){return undefined;}//console.log('FileStore.getStore ' + this.transactionCount++);\nreturn this.db.transaction(['keyvaluepairs'],'readonly').objectStore('keyvaluepairs');}},{key:\"getReadWriteStore\",value:function getReadWriteStore(){if(useReadFile){return undefined;}return this.db.transaction(['keyvaluepairs'],'readwrite').objectStore('keyvaluepairs');}},{key:\"getLocalFile\",value:function getLocalFile(store,file,arr,callback,faultCallback){var _this2=this;if(!useDownloadFile){return;}if(useReadFile){file=this.get(file.id)||file;if(file&&file.local&&!file.local.is_downloading_completed){faultCallback();return;}(function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(file){var response;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return TdLibController.send({'@type':'readFile',file_id:file.id});case 2:response=_context4.sent;console.log(\"readFile result file_id=\".concat(file.id),file,response);_this2.setBlob(file.id,response.data);case 5:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x4){return _ref3.apply(this,arguments);};})()(file).then(callback,faultCallback);return;}var idb_key=file.idb_key;if(!idb_key){file=this.get(file.id)||file;idb_key=file.idb_key;}if(!idb_key&&!arr){faultCallback();return;}if(arr){file.blob=new Blob([arr]);this.setBlob(file.id,file.blob);callback();return;}if(file.blob){//callback();\nreturn;}// if (this.getBlob(file.id)){\n//     return;\n// }\nvar request=store.get(idb_key);request.onsuccess=function(event){var blob=event.target.result;if(blob){file.blob=blob;_this2.setBlob(file.id,file.blob);callback();}else{faultCallback();}};request.onerror=function(){faultCallback();};}},{key:\"getRemoteFile\",value:function getRemoteFile(fileId,priority,obj){if(!useDownloadFile){return;}var items=this.downloads.get(fileId)||[];if(items.some(function(x){return x===obj;}))return;items.push(obj);this.downloads.set(fileId,items);TdLibController.send({'@type':'downloadFile',file_id:fileId,priority:priority});}},{key:\"cancelGetRemoteFile\",value:function cancelGetRemoteFile(fileId,obj){if(!this.downloads.has(fileId))return;if(!obj){this.downloads.delete(fileId);}else{var items=this.downloads.get(fileId).filter(function(x){return x!==obj;});this.downloads.set(fileId,items);}TdLibController.send({'@type':'cancelDownloadFile',file_id:fileId,only_if_pending:false});}},{key:\"uploadFile\",value:function uploadFile(fileId,obj){if(this.uploads.has(fileId)){var items=this.uploads.get(fileId);items.push(obj);}else{this.uploads.set(fileId,[obj]);}console.log('[perf] uploadFile file_id='+fileId);}},{key:\"cancelUploadFile\",value:function cancelUploadFile(fileId,obj){if(this.uploads.has(fileId)){this.uploads.delete(fileId);console.log('cancel_upload_message id='+obj.id);TdLibController.send({'@type':'deleteMessages',chat_id:obj.chat_id,message_ids:[obj.id],revoke:true});}}},{key:\"updateUserPhotoBlob\",value:function updateUserPhotoBlob(userId,fileId){this.emit('clientUpdateUserBlob',{userId:userId,fileId:fileId});}},{key:\"updateChatPhotoBlob\",value:function updateChatPhotoBlob(chatId,fileId){this.emit('clientUpdateChatBlob',{chatId:chatId,fileId:fileId});}}]);return FileStore;}(EventEmitter);var store=new FileStore();window.file=store;export default store;","map":{"version":3,"sources":["/home/me-admin/Downloads/my-app/src/Stores/FileStore.js"],"names":["EventEmitter","getLocationId","FILE_PRIORITY","IV_LOCATION_HEIGHT","IV_LOCATION_WIDTH","THUMBNAIL_PRIORITY","TdLibController","useReadFile","useDownloadFile","FileStore","reset","callbacks","db","urls","WeakMap","items","Map","blobItems","locationItems","downloads","uploads","onUpdate","update","onUpdateAuthorizationState","set","file","onUpdateFile","emit","onClientUpdate","addTdLibListener","addListener","removeTdLibListener","removeListener","authorization_state","initDB","handleDownloads","handleUploads","arr","id","idb_key","local","has","is_downloading_completed","get","delete","store","getStore","forEach","item","handleAnimation","handleAudio","handleChat","handleDocument","handleGame","handleLocation","handleMessage","handlePageBlockMap","handlePhoto","handleSticker","handleVideo","handleVideoNote","handleVoiceNote","handleUser","console","error","remote","is_uploading_completed","chat","getLocalFile","updateChatPhotoBlob","getRemoteFile","user","updateUserPhotoBlob","message","content","animation","audio","photo","document","game","location","sticker","web_page","video","video_note","voice_note","venue","obj","chatId","chat_id","messageId","thumbnail","source","updateAnimationThumbnailBlob","updateAnimationBlob","album_cover_thumbnail","updateAudioThumbnailBlob","updateAudioBlob","updateDocumentThumbnailBlob","updateDocumentBlob","locationId","getLocationFile","updateLocationBlob","pageBlockMap","i","sizes","length","photoSize","updatePhotoBlob","updateStickerThumbnailBlob","updateStickerBlob","voiceNote","voice","updateVoiceNoteBlob","videoNote","updateVideoNoteThumbnailBlob","updateVideoNoteBlob","updateVideoThumbnailBlob","updateVideoBlob","deleteLocalFile","fileId","getBlob","setBlob","blob","deleteBlob","setLocationFile","getBlobUrl","url","URL","createObjectURL","deleteBlobUrl","clientUpdate","setMaxListeners","Infinity","callback","log","initiatingDB","push","openDB","catch","Promise","resolve","reject","request","window","indexedDB","open","onsuccess","result","onerror","undefined","transaction","objectStore","faultCallback","send","file_id","response","data","then","Blob","event","target","priority","some","x","filter","only_if_pending","message_ids","revoke","userId"],"mappings":"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","sourcesContent":["/*\n *  Copyright (c) 2018-present, Evgeny Nadymov\n *\n * This source code is licensed under the GPL v.3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { EventEmitter } from 'events';\nimport { getLocationId } from '../Utils/Message';\nimport { FILE_PRIORITY, IV_LOCATION_HEIGHT, IV_LOCATION_WIDTH, THUMBNAIL_PRIORITY } from '../Constants';\nimport TdLibController from '../Controllers/TdLibController';\n\nconst useReadFile = true;\nconst useDownloadFile = true;\n\nclass FileStore extends EventEmitter {\n    constructor() {\n        super();\n\n        this.reset();\n\n        this.addTdLibListener();\n        this.setMaxListeners(Infinity);\n    }\n\n    reset = () => {\n        this.callbacks = [];\n\n        //this.transactionCount = 0;\n        this.db = null;\n        this.urls = new WeakMap();\n        this.items = new Map();\n        this.blobItems = new Map();\n        this.locationItems = new Map();\n\n        this.downloads = new Map();\n        this.uploads = new Map();\n    };\n\n    onUpdate = async update => {\n        switch (update['@type']) {\n            case 'updateAuthorizationState': {\n                await this.onUpdateAuthorizationState(update);\n\n                break;\n            }\n            case 'updateFile': {\n                this.set(update.file);\n\n                this.onUpdateFile(update);\n\n                this.emit(update['@type'], update);\n                break;\n            }\n            default:\n                break;\n        }\n    };\n\n    onClientUpdate = update => {\n        switch (update['@type']) {\n            case 'clientUpdateAudioThumbnailBlob': {\n                this.emit(update['@type'], update);\n                break;\n            }\n            case 'clientUpdateAudioBlob': {\n                this.emit(update['@type'], update);\n                break;\n            }\n            case 'clientUpdateDocumentBlob': {\n                this.emit(update['@type'], update);\n                break;\n            }\n            default:\n                break;\n        }\n    };\n\n    addTdLibListener = () => {\n        TdLibController.addListener('update', this.onUpdate);\n        TdLibController.addListener('clientUpdate', this.onClientUpdate);\n    };\n\n    removeTdLibListener = () => {\n        TdLibController.removeListener('update', this.onUpdate);\n        TdLibController.removeListener('clientUpdate', this.onClientUpdate);\n    };\n\n    onUpdateAuthorizationState = async update => {\n        if (!update) return;\n\n        const { authorization_state } = update;\n        if (!authorization_state) return;\n\n        switch (authorization_state['@type']) {\n            case 'authorizationStateWaitTdlibParameters': {\n                await this.initDB();\n                break;\n            }\n            case 'authorizationStateClosed': {\n                this.reset();\n                break;\n            }\n        }\n    };\n\n    onUpdateFile = update => {\n        if (!update) return;\n\n        const { file } = update;\n        if (!file) return;\n\n        this.handleDownloads(file);\n        this.handleUploads(file);\n    };\n\n    handleDownloads = file => {\n        const { arr, id, idb_key, local } = file;\n        delete file.arr;\n\n        if (!this.downloads.has(id)) return;\n        if (!local.is_downloading_completed) return;\n        if (!useReadFile && !idb_key && !arr) return;\n\n        const items = this.downloads.get(id);\n        if (!items) return;\n\n        this.downloads.delete(id);\n\n        const store = this.getStore();\n\n        items.forEach(item => {\n            switch (item['@type']) {\n                case 'animation': {\n                    this.handleAnimation(store, item, file, arr, null);\n                    break;\n                }\n                case 'audio': {\n                    this.handleAudio(store, item, file, arr, null);\n                    break;\n                }\n                case 'chat': {\n                    this.handleChat(store, item, file, arr);\n                    break;\n                }\n                case 'document': {\n                    this.handleDocument(store, item, file, arr, null);\n                    break;\n                }\n                case 'game': {\n                    this.handleGame(store, item, file, arr, null);\n                    break;\n                }\n                case 'location': {\n                    this.handleLocation(store, item, file, arr, null);\n                    break;\n                }\n                case 'message': {\n                    this.handleMessage(store, item, file, arr);\n                    break;\n                }\n                case 'pageBlockMap': {\n                    this.handlePageBlockMap(store, item, file, arr, null);\n                    break;\n                }\n                case 'photo': {\n                    this.handlePhoto(store, item, file, arr, null);\n                    break;\n                }\n                case 'sticker': {\n                    this.handleSticker(store, item, file, arr, null);\n                    break;\n                }\n                case 'video': {\n                    this.handleVideo(store, item, file, arr, null);\n                    break;\n                }\n                case 'videoNote': {\n                    this.handleVideoNote(store, item, file, arr, null);\n                    break;\n                }\n                case 'voiceNote': {\n                    this.handleVoiceNote(store, item, file, arr, null);\n                    break;\n                }\n                case 'user': {\n                    this.handleUser(store, item, file, arr);\n                    break;\n                }\n                default:\n                    console.error('FileStore.onUpdateFile unhandled item', item);\n                    break;\n            }\n        });\n    };\n\n    handleUploads = file => {\n        const { id, remote } = file;\n        delete file.arr;\n\n        if (!this.uploads.has(id)) return;\n        if (remote.is_uploading_completed) return;\n\n        this.uploads.delete(id);\n    };\n\n    handleChat = (store, chat, file, arr) => {\n        if (!chat) return;\n\n        this.getLocalFile(\n            store,\n            file,\n            arr,\n            () => this.updateChatPhotoBlob(chat.id, file.id),\n            () => this.getRemoteFile(file.id, FILE_PRIORITY, chat)\n        );\n    };\n\n    handleUser = (store, user, file, arr) => {\n        if (!user) return;\n\n        this.getLocalFile(\n            store,\n            file,\n            arr,\n            () => this.updateUserPhotoBlob(user.id, file.id),\n            () => this.getRemoteFile(file.id, FILE_PRIORITY, user)\n        );\n    };\n\n    handleMessage = (store, message, file, arr) => {\n        if (!message) return;\n\n        const { content } = message;\n        if (!content) return;\n\n        switch (content['@type']) {\n            case 'messageAnimation': {\n                const { animation } = content;\n\n                this.handleAnimation(store, animation, file, arr, message);\n                break;\n            }\n            case 'messageAudio': {\n                const { audio } = content;\n\n                this.handleAudio(store, audio, file, arr, message);\n                break;\n            }\n            case 'messageChatChangePhoto': {\n                const { photo } = content;\n\n                this.handlePhoto(store, photo, file, arr, message);\n                break;\n            }\n            case 'messageDocument': {\n                const { document } = content;\n\n                this.handleDocument(store, document, file, arr, message);\n                break;\n            }\n            case 'messageGame': {\n                const { game } = content;\n\n                this.handleGame(store, game, file, arr, message);\n                break;\n            }\n            case 'messageLocation': {\n                const { location } = content;\n\n                this.handleLocation(store, location, file, arr, message);\n                break;\n            }\n            case 'messagePhoto': {\n                const { photo } = content;\n\n                this.handlePhoto(store, photo, file, arr, message);\n                break;\n            }\n            case 'messageSticker': {\n                const { sticker } = content;\n\n                this.handleSticker(store, sticker, file, arr, message);\n                break;\n            }\n            case 'messageText': {\n                const { web_page } = content;\n                if (!web_page) break;\n\n                const { animation, audio, document, photo, sticker, video, video_note, voice_note } = web_page;\n\n                if (animation) {\n                    this.handleAnimation(store, animation, file, arr, message);\n                }\n\n                if (audio) {\n                    this.handleAudio(store, audio, file, arr, message);\n                }\n\n                if (document) {\n                    this.handleDocument(store, document, file, arr, message);\n                }\n\n                if (photo) {\n                    this.handlePhoto(store, photo, file, arr, message);\n                }\n\n                if (sticker) {\n                    this.handleSticker(store, sticker, file, arr, message);\n                }\n\n                if (video) {\n                    this.handleVideo(store, video, file, arr, message);\n                }\n\n                if (voice_note) {\n                    this.handleVoiceNote(store, voice_note, file, arr, message);\n                }\n\n                if (video_note) {\n                    this.handleVideoNote(store, video_note, file, arr, message);\n                }\n\n                break;\n            }\n            case 'messageVenue': {\n                const { venue } = content;\n                const { location } = venue;\n\n                this.handleLocation(store, location, file, arr, message);\n                break;\n            }\n            case 'messageVideo': {\n                const { video } = content;\n\n                this.handleVideo(store, video, file, arr, message);\n                break;\n            }\n            case 'messageVideoNote': {\n                const { video_note } = content;\n\n                this.handleVideoNote(store, video_note, file, arr, message);\n                break;\n            }\n            case 'messageVoiceNote': {\n                const { voice_note } = content;\n\n                this.handleVoiceNote(store, voice_note, file, arr, message);\n                break;\n            }\n            default:\n                break;\n        }\n    };\n\n    handleAnimation = (store, animation, file, arr, obj) => {\n        const chatId = obj ? obj.chat_id : 0;\n        const messageId = obj ? obj.id : 0;\n\n        if (animation.thumbnail) {\n            const source = animation.thumbnail.photo;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateAnimationThumbnailBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, THUMBNAIL_PRIORITY, obj || animation)\n                );\n            }\n        }\n\n        if (animation.animation) {\n            const source = animation.animation;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateAnimationBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, FILE_PRIORITY, obj || animation)\n                );\n            }\n        }\n    };\n\n    handleAudio = (store, audio, file, arr, obj) => {\n        const chatId = obj ? obj.chat_id : 0;\n        const messageId = obj ? obj.id : 0;\n\n        if (audio.album_cover_thumbnail) {\n            const source = audio.album_cover_thumbnail.photo;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateAudioThumbnailBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, THUMBNAIL_PRIORITY, obj || audio)\n                );\n            }\n        }\n\n        if (audio.audio) {\n            const source = audio.audio;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateAudioBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, FILE_PRIORITY, obj || audio)\n                );\n            }\n        }\n    };\n\n    handleGame = (store, game, file, arr, message) => {\n        if (!game) return;\n\n        const { animation, photo } = game;\n        if (photo) {\n            this.handlePhoto(store, photo, file, arr, message);\n        }\n\n        if (animation) {\n            this.handleAnimation(store, animation, file, arr, message);\n        }\n    };\n\n    handleDocument = (store, document, file, arr, obj) => {\n        const chatId = obj ? obj.chat_id : 0;\n        const messageId = obj ? obj.id : 0;\n\n        if (document.thumbnail) {\n            const { photo: source } = document.thumbnail;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateDocumentThumbnailBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, THUMBNAIL_PRIORITY, obj || document)\n                );\n            }\n        }\n\n        if (document.document) {\n            const { document: source } = document;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateDocumentBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, FILE_PRIORITY, obj || document)\n                );\n            }\n        }\n    };\n\n    handleLocation = (store, location, file, arr, obj) => {\n        const chatId = obj ? obj.chat_id : 0;\n        const messageId = obj ? obj.id : 0;\n\n        const locationId = getLocationId(location);\n        if (locationId) {\n            const source = this.getLocationFile(locationId);\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateLocationBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, THUMBNAIL_PRIORITY, obj || location)\n                );\n            }\n        }\n    };\n\n    handlePageBlockMap = (store, pageBlockMap, file, arr, obj) => {\n        const chatId = obj ? obj.chat_id : 0;\n        const messageId = obj ? obj.id : 0;\n\n        const { location } = pageBlockMap;\n        const locationId = getLocationId(location, IV_LOCATION_WIDTH, IV_LOCATION_HEIGHT);\n        if (locationId) {\n            const source = this.getLocationFile(locationId);\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateLocationBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, THUMBNAIL_PRIORITY, obj || pageBlockMap)\n                );\n            }\n        }\n    };\n\n    handlePhoto = (store, photo, file, arr, obj) => {\n        const chatId = obj ? obj.chat_id : 0;\n        const messageId = obj ? obj.id : 0;\n\n        if (photo) {\n            for (let i = 0; i < photo.sizes.length; i++) {\n                const photoSize = photo.sizes[i];\n                if (photoSize) {\n                    const source = photoSize.photo;\n                    if (source && source.id === file.id) {\n                        this.getLocalFile(\n                            store,\n                            source,\n                            arr,\n                            () => this.updatePhotoBlob(chatId, messageId, file.id),\n                            () => this.getRemoteFile(file.id, FILE_PRIORITY, obj || photo)\n                        );\n                        break;\n                    }\n                }\n            }\n        }\n    };\n\n    handleSticker = (store, sticker, file, arr, obj) => {\n        const chatId = obj ? obj.chat_id : 0;\n        const messageId = obj ? obj.id : 0;\n\n        if (sticker.thumbnail) {\n            const source = sticker.thumbnail.photo;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateStickerThumbnailBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, THUMBNAIL_PRIORITY, obj || sticker)\n                );\n            }\n        }\n\n        if (sticker.sticker) {\n            const source = sticker.sticker;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateStickerBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, FILE_PRIORITY, obj || sticker)\n                );\n            }\n        }\n    };\n\n    handleVoiceNote = (store, voiceNote, file, arr, obj) => {\n        const chatId = obj ? obj.chat_id : 0;\n        const messageId = obj ? obj.id : 0;\n\n        if (voiceNote.voice) {\n            const source = voiceNote.voice;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateVoiceNoteBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, FILE_PRIORITY, obj || voiceNote)\n                );\n            }\n        }\n    };\n\n    handleVideoNote = (store, videoNote, file, arr, obj) => {\n        const chatId = obj ? obj.chat_id : 0;\n        const messageId = obj ? obj.id : 0;\n\n        if (videoNote.thumbnail) {\n            const source = videoNote.thumbnail.photo;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateVideoNoteThumbnailBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, THUMBNAIL_PRIORITY, obj || videoNote)\n                );\n            }\n        }\n\n        if (videoNote.video) {\n            const source = videoNote.video;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateVideoNoteBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, FILE_PRIORITY, obj || videoNote)\n                );\n            }\n        }\n    };\n\n    handleVideo = (store, video, file, arr, obj) => {\n        const chatId = obj ? obj.chat_id : 0;\n        const messageId = obj ? obj.id : 0;\n\n        if (video.thumbnail) {\n            const source = video.thumbnail.photo;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateVideoThumbnailBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, THUMBNAIL_PRIORITY, obj || video)\n                );\n            }\n        }\n\n        if (video.video) {\n            const source = video.video;\n            if (source && source.id === file.id) {\n                this.getLocalFile(\n                    store,\n                    source,\n                    arr,\n                    () => this.updateVideoBlob(chatId, messageId, file.id),\n                    () => this.getRemoteFile(file.id, FILE_PRIORITY, obj || video)\n                );\n            }\n        }\n    };\n\n    async initDB(callback) {\n        /*if (this.store) return;\n            if (this.initiatingDB) return;\n\n            this.initiatingDB = true;\n            this.store = localForage.createInstance({\n                name: 'tdlib'\n            });\n            this.initiatingDB = false;\n\n            return;*/\n        if (this.db) {\n            console.log('[FileStore] db exists');\n            if (callback) callback();\n            return;\n        }\n\n        if (this.initiatingDB) {\n            console.log('[FileStore] add callback');\n            if (callback) this.callbacks.push(callback);\n            return;\n        }\n\n        console.log('[FileStore] start initDB');\n        if (callback) this.callbacks.push(callback);\n\n        this.initiatingDB = true;\n        this.db = await this.openDB().catch(error => console.log('[FileStore] initDB error', error));\n        this.initiatingDB = false;\n\n        console.log('[FileStore] stop initDB');\n\n        if (this.callbacks.length) {\n            console.log('[FileStore] invoke callbacks count=' + this.callbacks.length);\n            for (let i = 0; i < this.callbacks.length; i++) {\n                this.callbacks[i]();\n            }\n            this.callbacks = [];\n        }\n    }\n\n    openDB() {\n        return new Promise((resolve, reject) => {\n            const request = window.indexedDB.open('tdlib');\n            request.onsuccess = () => resolve(request.result);\n            request.onerror = () => reject(request.error);\n        });\n    }\n\n    getStore() {\n        if (useReadFile) {\n            return undefined;\n        }\n\n        //console.log('FileStore.getStore ' + this.transactionCount++);\n        return this.db.transaction(['keyvaluepairs'], 'readonly').objectStore('keyvaluepairs');\n    }\n\n    getReadWriteStore() {\n        if (useReadFile) {\n            return undefined;\n        }\n\n        return this.db.transaction(['keyvaluepairs'], 'readwrite').objectStore('keyvaluepairs');\n    }\n\n    deleteLocalFile = (store, file) => {};\n\n    getLocalFile(store, file, arr, callback, faultCallback) {\n        if (!useDownloadFile) {\n            return;\n        }\n\n        if (useReadFile) {\n            file = this.get(file.id) || file;\n            if (file && file.local && !file.local.is_downloading_completed) {\n                faultCallback();\n                return;\n            }\n\n            (async file => {\n                const response = await TdLibController.send({\n                    '@type': 'readFile',\n                    file_id: file.id\n                });\n\n                console.log(`readFile result file_id=${file.id}`, file, response);\n                this.setBlob(file.id, response.data);\n            })(file).then(callback, faultCallback);\n\n            return;\n        }\n\n        let idb_key = file.idb_key;\n        if (!idb_key) {\n            file = this.get(file.id) || file;\n            idb_key = file.idb_key;\n        }\n\n        if (!idb_key && !arr) {\n            faultCallback();\n            return;\n        }\n\n        if (arr) {\n            file.blob = new Blob([arr]);\n            this.setBlob(file.id, file.blob);\n            callback();\n            return;\n        }\n\n        if (file.blob) {\n            //callback();\n            return;\n        }\n\n        // if (this.getBlob(file.id)){\n        //     return;\n        // }\n\n        const request = store.get(idb_key);\n        request.onsuccess = event => {\n            const blob = event.target.result;\n\n            if (blob) {\n                file.blob = blob;\n                this.setBlob(file.id, file.blob);\n                callback();\n            } else {\n                faultCallback();\n            }\n        };\n        request.onerror = () => {\n            faultCallback();\n        };\n    }\n\n    getRemoteFile(fileId, priority, obj) {\n        if (!useDownloadFile) {\n            return;\n        }\n\n        const items = this.downloads.get(fileId) || [];\n        if (items.some(x => x === obj)) return;\n\n        items.push(obj);\n        this.downloads.set(fileId, items);\n\n        TdLibController.send({\n            '@type': 'downloadFile',\n            file_id: fileId,\n            priority: priority\n        });\n    }\n\n    cancelGetRemoteFile(fileId, obj) {\n        if (!this.downloads.has(fileId)) return;\n\n        if (!obj) {\n            this.downloads.delete(fileId);\n        } else {\n            const items = this.downloads.get(fileId).filter(x => x !== obj);\n            this.downloads.set(fileId, items);\n        }\n\n        TdLibController.send({\n            '@type': 'cancelDownloadFile',\n            file_id: fileId,\n            only_if_pending: false\n        });\n    }\n\n    uploadFile(fileId, obj) {\n        if (this.uploads.has(fileId)) {\n            let items = this.uploads.get(fileId);\n            items.push(obj);\n        } else {\n            this.uploads.set(fileId, [obj]);\n        }\n\n        console.log('[perf] uploadFile file_id=' + fileId);\n    }\n\n    cancelUploadFile(fileId, obj) {\n        if (this.uploads.has(fileId)) {\n            this.uploads.delete(fileId);\n            console.log('cancel_upload_message id=' + obj.id);\n            TdLibController.send({\n                '@type': 'deleteMessages',\n                chat_id: obj.chat_id,\n                message_ids: [obj.id],\n                revoke: true\n            });\n        }\n    }\n\n    get = fileId => {\n        return this.items.get(fileId);\n    };\n\n    set = file => {\n        this.items.set(file.id, file);\n    };\n\n    getBlob = fileId => {\n        return this.blobItems.get(fileId);\n    };\n\n    setBlob = (fileId, blob) => {\n        this.blobItems.set(fileId, blob);\n    };\n\n    deleteBlob = fileId => {\n        this.blobItems.delete(fileId);\n    };\n\n    getLocationFile = locationId => {\n        const fileId = this.locationItems.get(locationId);\n\n        return this.get(fileId);\n    };\n\n    setLocationFile = (locationId, file) => {\n        this.locationItems.set(locationId, file.id);\n\n        this.set(file);\n    };\n\n    getBlobUrl = blob => {\n        if (!blob) {\n            return null;\n        }\n\n        if (this.urls.has(blob)) {\n            return this.urls.get(blob);\n        }\n\n        const url = URL.createObjectURL(blob);\n        this.urls.set(blob, url);\n\n        return url;\n    };\n\n    deleteBlobUrl = blob => {\n        if (this.urls.has(blob)) {\n            this.urls.delete(blob);\n        }\n    };\n\n    updatePhotoBlob = (chatId, messageId, fileId) => {\n        this.emit('clientUpdatePhotoBlob', {\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateAudioThumbnailBlob = (chatId, messageId, fileId) => {\n        TdLibController.clientUpdate({\n            '@type': 'clientUpdateAudioThumbnailBlob',\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateAudioBlob = (chatId, messageId, fileId) => {\n        TdLibController.clientUpdate({\n            '@type': 'clientUpdateAudioBlob',\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateVoiceNoteBlob = (chatId, messageId, fileId) => {\n        this.emit('clientUpdateVoiceNoteBlob', {\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateVideoNoteThumbnailBlob = (chatId, messageId, fileId) => {\n        this.emit('clientUpdateVideoNoteThumbnailBlob', {\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateVideoNoteBlob = (chatId, messageId, fileId) => {\n        this.emit('clientUpdateVideoNoteBlob', {\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateAnimationThumbnailBlob = (chatId, messageId, fileId) => {\n        this.emit('clientUpdateAnimationThumbnailBlob', {\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateAnimationBlob = (chatId, messageId, fileId) => {\n        this.emit('clientUpdateAnimationBlob', {\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateDocumentBlob = (chatId, messageId, fileId) => {\n        TdLibController.clientUpdate({\n            '@type': 'clientUpdateDocumentBlob',\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateVideoThumbnailBlob = (chatId, messageId, fileId) => {\n        this.emit('clientUpdateVideoThumbnailBlob', {\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateVideoBlob = (chatId, messageId, fileId) => {\n        this.emit('clientUpdateVideoBlob', {\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateStickerThumbnailBlob = (chatId, messageId, fileId) => {\n        this.emit('clientUpdateStickerThumbnailBlob', {\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateStickerBlob = (chatId, messageId, fileId) => {\n        this.emit('clientUpdateStickerBlob', {\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateLocationBlob = (chatId, messageId, fileId) => {\n        this.emit('clientUpdateLocationBlob', {\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateDocumentThumbnailBlob = (chatId, messageId, fileId) => {\n        this.emit('clientUpdateDocumentThumbnailBlob', {\n            chatId: chatId,\n            messageId: messageId,\n            fileId: fileId\n        });\n    };\n\n    updateUserPhotoBlob(userId, fileId) {\n        this.emit('clientUpdateUserBlob', {\n            userId: userId,\n            fileId: fileId\n        });\n    }\n\n    updateChatPhotoBlob(chatId, fileId) {\n        this.emit('clientUpdateChatBlob', {\n            chatId: chatId,\n            fileId: fileId\n        });\n    }\n}\n\nconst store = new FileStore();\nwindow.file = store;\nexport default store;\n"]},"metadata":{},"sourceType":"module"}