{"ast":null,"code":"import _regeneratorRuntime from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _possibleConstructorReturn from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";import _inherits from\"/home/me-admin/Downloads/my-app/node_modules/@babel/runtime/helpers/esm/inherits\";/*\n *  Copyright (c) 2018-present, Evgeny Nadymov\n *\n * This source code is licensed under the GPL v.3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */import{EventEmitter}from'events';import packageJson from'../../package.json';import{stringToBoolean,getBrowser,getOSName}from'../Utils/Common';import{VERBOSITY_JS_MAX,VERBOSITY_JS_MIN,VERBOSITY_MAX,VERBOSITY_MIN,WASM_FILE_HASH,WASM_FILE_NAME}from'../Constants';import TdClient from'tdweb/dist/tdweb';function databaseExists(dbname,callback){var req=indexedDB.open(dbname);var existed=true;req.onsuccess=function(){req.result.close();if(!existed)indexedDB.deleteDatabase(dbname);callback(existed);};req.onupgradeneeded=function(){existed=false;};}var TdLibController=/*#__PURE__*/function(_EventEmitter){_inherits(TdLibController,_EventEmitter);function TdLibController(){var _this;_classCallCheck(this,TdLibController);_this=_possibleConstructorReturn(this,_getPrototypeOf(TdLibController).call(this));_this.init=function(location){_this.setParameters(location);var _this$parameters=_this.parameters,verbosity=_this$parameters.verbosity,jsVerbosity=_this$parameters.jsVerbosity,useTestDC=_this$parameters.useTestDC,readOnly=_this$parameters.readOnly,fastUpdating=_this$parameters.fastUpdating,useDatabase=_this$parameters.useDatabase,mode=_this$parameters.mode;var dbName=useTestDC?'tdlib_test':'tdlib';databaseExists(dbName,function(exists){_this.clientUpdate({'@type':'clientUpdateDatabaseExists',exists:exists});var options={logVerbosityLevel:verbosity,jsLogVerbosityLevel:jsVerbosity,mode:mode,// 'wasm-streaming'/'wasm'/'asmjs'\nprefix:useTestDC?'tdlib_test':'tdlib',readOnly:readOnly,isBackground:false,useDatabase:useDatabase,wasmUrl:\"\".concat(WASM_FILE_NAME,\"?_sw-precache=\").concat(WASM_FILE_HASH)// onUpdate: update => this.emit('update', update)\n};console.log(\"[TdLibController] (fast_updating=\".concat(fastUpdating,\") Start client with params=\").concat(JSON.stringify(options)));_this.client=new TdClient(options);_this.client.onUpdate=function(update){if(!_this.disableLog){if(update['@type']==='updateFile'){console.log('receive updateFile file_id='+update.file.id,update);}else{console.log('receive update',update);}}_this.emit('update',update);};});};_this.clientUpdate=function(update){if(!_this.disableLog){console.log('clientUpdate',update);}_this.emit('clientUpdate',update);};_this.setParameters=function(location){if(!location)return;var search=location.search;if(!search)return;var params=new URLSearchParams(search.toLowerCase());if(params.has('test')){_this.parameters.useTestDC=stringToBoolean(params.get('test'));}if(params.has('verbosity')){var verbosity=parseInt(params.get('verbosity'),10);if(verbosity>=VERBOSITY_MIN&&verbosity<=VERBOSITY_MAX){_this.parameters.verbosity=verbosity;}}if(params.has('jsverbosity')){var jsVerbosity=parseInt(params.get('jsverbosity'),10);if(jsVerbosity>=VERBOSITY_JS_MIN&&jsVerbosity<=VERBOSITY_JS_MAX){_this.parameters.jsVerbosity=jsVerbosity;}}if(params.has('tag')&&params.has('tagverbosity')){var tag=params.get('tag').replace('[','').replace(']','').split(',');var tagVerbosity=params.get('tagverbosity').replace('[','').replace(']','').split(',');if(tag&&tagVerbosity&&tag.length===tagVerbosity.length){_this.parameters.tag=tag;_this.parameters.tagVerbosity=tagVerbosity;}}if(params.has('readonly')){_this.parameters.readOnly=stringToBoolean(params.get('readonly'));}if(params.has('fastupdating')){_this.parameters.fastUpdating=stringToBoolean(params.get('fastupdating'));}if(params.has('db')){_this.parameters.useDatabase=stringToBoolean(params.get('db'));}if(params.has('mode')){_this.parameters.mode=params.get('mode');}};_this.send=function(request){if(!_this.disableLog){console.log('send',request);return _this.client.send(request).then(function(result){console.log('receive',result);return result;}).catch(function(error){console.error('catch',error);throw error;});}else{return _this.client.send(request);}};_this.sendTdParameters=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var apiId,apiHash,useTestDC,version,i,tag,tagVerbosity;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:apiId=process.env.REACT_APP_TELEGRAM_API_ID;apiHash=process.env.REACT_APP_TELEGRAM_API_HASH;if(!apiId||!apiHash){if(window.confirm('API id is missing!\\n'+'In order to obtain an API id and develop your own application '+'using the Telegram API please visit https://core.telegram.org/api/obtaining_api_id')){window.location.href='https://core.telegram.org/api/obtaining_api_id';}}useTestDC=_this.parameters.useTestDC;version=packageJson.version;_this.send({'@type':'setTdlibParameters',parameters:{'@type':'tdParameters',use_test_dc:useTestDC,api_id:apiId,api_hash:apiHash,system_language_code:navigator.language||'en',device_model:getBrowser(),system_version:getOSName(),application_version:version,use_secret_chats:false,use_message_database:true,use_file_database:false,database_directory:'/db',files_directory:'/'}// ,\n// extra: {\n//     a: ['a', 'b'],\n//     b: 123\n// }\n});if(_this.parameters.tag&&_this.parameters.tagVerbosity){for(i=0;i<_this.parameters.tag.length;i++){tag=_this.parameters.tag[i];tagVerbosity=_this.parameters.tagVerbosity[i];_this.send({'@type':'setLogTagVerbosityLevel',tag:tag,new_verbosity_level:tagVerbosity});}}case 7:case\"end\":return _context.stop();}}},_callee);}));_this.setChatId=function(chatId){var messageId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var update={'@type':'clientUpdateChatId',chatId:chatId,messageId:messageId};_this.clientUpdate(update);};_this.parameters={useTestDC:false,readOnly:false,verbosity:1,jsVerbosity:3,fastUpdating:true,useDatabase:false,mode:'wasm'};_this.disableLog=false;_this.setMaxListeners(Infinity);return _this;}_createClass(TdLibController,[{key:\"logOut\",value:function logOut(){var _this2=this;this.send({'@type':'logOut'}).catch(function(error){_this2.emit('tdlib_auth_error',error);});}},{key:\"setMediaViewerContent\",value:function setMediaViewerContent(content){this.clientUpdate({'@type':'clientUpdateMediaViewerContent',content:content});}}]);return TdLibController;}(EventEmitter);var controller=new TdLibController();export default controller;","map":{"version":3,"sources":["/home/me-admin/Downloads/my-app/src/Controllers/TdLibController.js"],"names":["EventEmitter","packageJson","stringToBoolean","getBrowser","getOSName","VERBOSITY_JS_MAX","VERBOSITY_JS_MIN","VERBOSITY_MAX","VERBOSITY_MIN","WASM_FILE_HASH","WASM_FILE_NAME","TdClient","databaseExists","dbname","callback","req","indexedDB","open","existed","onsuccess","result","close","deleteDatabase","onupgradeneeded","TdLibController","init","location","setParameters","parameters","verbosity","jsVerbosity","useTestDC","readOnly","fastUpdating","useDatabase","mode","dbName","exists","clientUpdate","options","logVerbosityLevel","jsLogVerbosityLevel","prefix","isBackground","wasmUrl","console","log","JSON","stringify","client","onUpdate","update","disableLog","file","id","emit","search","params","URLSearchParams","toLowerCase","has","get","parseInt","tag","replace","split","tagVerbosity","length","send","request","then","catch","error","sendTdParameters","apiId","process","env","REACT_APP_TELEGRAM_API_ID","apiHash","REACT_APP_TELEGRAM_API_HASH","window","confirm","href","version","use_test_dc","api_id","api_hash","system_language_code","navigator","language","device_model","system_version","application_version","use_secret_chats","use_message_database","use_file_database","database_directory","files_directory","i","new_verbosity_level","setChatId","chatId","messageId","setMaxListeners","Infinity","content","controller"],"mappings":"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","sourcesContent":["/*\n *  Copyright (c) 2018-present, Evgeny Nadymov\n *\n * This source code is licensed under the GPL v.3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { EventEmitter } from 'events';\nimport packageJson from '../../package.json';\nimport { stringToBoolean, getBrowser, getOSName } from '../Utils/Common';\nimport {\n    VERBOSITY_JS_MAX,\n    VERBOSITY_JS_MIN,\n    VERBOSITY_MAX,\n    VERBOSITY_MIN,\n    WASM_FILE_HASH,\n    WASM_FILE_NAME\n} from '../Constants';\nimport TdClient from 'tdweb/dist/tdweb';\n\nfunction databaseExists(dbname, callback) {\n    var req = indexedDB.open(dbname);\n    var existed = true;\n    req.onsuccess = function() {\n        req.result.close();\n        if (!existed) indexedDB.deleteDatabase(dbname);\n        callback(existed);\n    };\n    req.onupgradeneeded = function() {\n        existed = false;\n    };\n}\n\nclass TdLibController extends EventEmitter {\n    constructor() {\n        super();\n\n        this.parameters = {\n            useTestDC: false,\n            readOnly: false,\n            verbosity: 1,\n            jsVerbosity: 3,\n            fastUpdating: true,\n            useDatabase: false,\n            mode: 'wasm'\n        };\n\n        this.disableLog = false;\n\n        this.setMaxListeners(Infinity);\n    }\n\n    init = location => {\n        this.setParameters(location);\n\n        const { verbosity, jsVerbosity, useTestDC, readOnly, fastUpdating, useDatabase, mode } = this.parameters;\n        const dbName = useTestDC ? 'tdlib_test' : 'tdlib';\n\n        databaseExists(dbName, exists => {\n            this.clientUpdate({ '@type': 'clientUpdateDatabaseExists', exists });\n\n            let options = {\n                logVerbosityLevel: verbosity,\n                jsLogVerbosityLevel: jsVerbosity,\n                mode: mode, // 'wasm-streaming'/'wasm'/'asmjs'\n                prefix: useTestDC ? 'tdlib_test' : 'tdlib',\n                readOnly: readOnly,\n                isBackground: false,\n                useDatabase: useDatabase,\n                wasmUrl: `${WASM_FILE_NAME}?_sw-precache=${WASM_FILE_HASH}`\n                // onUpdate: update => this.emit('update', update)\n            };\n\n            console.log(\n                `[TdLibController] (fast_updating=${fastUpdating}) Start client with params=${JSON.stringify(options)}`\n            );\n\n            this.client = new TdClient(options);\n            this.client.onUpdate = update => {\n                if (!this.disableLog) {\n                    if (update['@type'] === 'updateFile') {\n                        console.log('receive updateFile file_id=' + update.file.id, update);\n                    } else {\n                        console.log('receive update', update);\n                    }\n                }\n                this.emit('update', update);\n            };\n        });\n    };\n\n    clientUpdate = update => {\n        if (!this.disableLog) {\n            console.log('clientUpdate', update);\n        }\n        this.emit('clientUpdate', update);\n    };\n\n    setParameters = location => {\n        if (!location) return;\n\n        const { search } = location;\n        if (!search) return;\n\n        const params = new URLSearchParams(search.toLowerCase());\n\n        if (params.has('test')) {\n            this.parameters.useTestDC = stringToBoolean(params.get('test'));\n        }\n\n        if (params.has('verbosity')) {\n            const verbosity = parseInt(params.get('verbosity'), 10);\n            if (verbosity >= VERBOSITY_MIN && verbosity <= VERBOSITY_MAX) {\n                this.parameters.verbosity = verbosity;\n            }\n        }\n\n        if (params.has('jsverbosity')) {\n            const jsVerbosity = parseInt(params.get('jsverbosity'), 10);\n            if (jsVerbosity >= VERBOSITY_JS_MIN && jsVerbosity <= VERBOSITY_JS_MAX) {\n                this.parameters.jsVerbosity = jsVerbosity;\n            }\n        }\n\n        if (params.has('tag') && params.has('tagverbosity')) {\n            const tag = params\n                .get('tag')\n                .replace('[', '')\n                .replace(']', '')\n                .split(',');\n            const tagVerbosity = params\n                .get('tagverbosity')\n                .replace('[', '')\n                .replace(']', '')\n                .split(',');\n            if (tag && tagVerbosity && tag.length === tagVerbosity.length) {\n                this.parameters.tag = tag;\n                this.parameters.tagVerbosity = tagVerbosity;\n            }\n        }\n\n        if (params.has('readonly')) {\n            this.parameters.readOnly = stringToBoolean(params.get('readonly'));\n        }\n\n        if (params.has('fastupdating')) {\n            this.parameters.fastUpdating = stringToBoolean(params.get('fastupdating'));\n        }\n\n        if (params.has('db')) {\n            this.parameters.useDatabase = stringToBoolean(params.get('db'));\n        }\n        if (params.has('mode')) {\n            this.parameters.mode = params.get('mode');\n        }\n    };\n\n    send = request => {\n        if (!this.disableLog) {\n            console.log('send', request);\n            return this.client\n                .send(request)\n                .then(result => {\n                    console.log('receive', result);\n                    return result;\n                })\n                .catch(error => {\n                    console.error('catch', error);\n\n                    throw error;\n                });\n        } else {\n            return this.client.send(request);\n        }\n    };\n\n    sendTdParameters = async () => {\n        const apiId = process.env.REACT_APP_TELEGRAM_API_ID;\n        const apiHash = process.env.REACT_APP_TELEGRAM_API_HASH;\n\n        if (!apiId || !apiHash) {\n            if (\n                window.confirm(\n                    'API id is missing!\\n' +\n                        'In order to obtain an API id and develop your own application ' +\n                        'using the Telegram API please visit https://core.telegram.org/api/obtaining_api_id'\n                )\n            ) {\n                window.location.href = 'https://core.telegram.org/api/obtaining_api_id';\n            }\n        }\n\n        const { useTestDC } = this.parameters;\n        const { version } = packageJson;\n\n        this.send({\n            '@type': 'setTdlibParameters',\n            parameters: {\n                '@type': 'tdParameters',\n                use_test_dc: useTestDC,\n                api_id: apiId,\n                api_hash: apiHash,\n                system_language_code: navigator.language || 'en',\n                device_model: getBrowser(),\n                system_version: getOSName(),\n                application_version: version,\n                use_secret_chats: false,\n                use_message_database: true,\n                use_file_database: false,\n                database_directory: '/db',\n                files_directory: '/'\n            }\n            // ,\n            // extra: {\n            //     a: ['a', 'b'],\n            //     b: 123\n            // }\n        });\n\n        if (this.parameters.tag && this.parameters.tagVerbosity) {\n            for (let i = 0; i < this.parameters.tag.length; i++) {\n                let tag = this.parameters.tag[i];\n                let tagVerbosity = this.parameters.tagVerbosity[i];\n\n                this.send({\n                    '@type': 'setLogTagVerbosityLevel',\n                    tag: tag,\n                    new_verbosity_level: tagVerbosity\n                });\n            }\n        }\n    };\n\n    logOut() {\n        this.send({ '@type': 'logOut' }).catch(error => {\n            this.emit('tdlib_auth_error', error);\n        });\n    }\n\n    setChatId = (chatId, messageId = null) => {\n        const update = {\n            '@type': 'clientUpdateChatId',\n            chatId: chatId,\n            messageId: messageId\n        };\n\n        this.clientUpdate(update);\n    };\n\n    setMediaViewerContent(content) {\n        this.clientUpdate({\n            '@type': 'clientUpdateMediaViewerContent',\n            content: content\n        });\n    }\n}\n\nconst controller = new TdLibController();\n\nexport default controller;\n"]},"metadata":{},"sourceType":"module"}