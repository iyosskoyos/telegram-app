{"ast":null,"code":"import _regeneratorRuntime from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _toConsumableArray from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _classCallCheck from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _possibleConstructorReturn from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";import _assertThisInitialized from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";import _createClass from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/inherits\";/*\n *  Copyright (c) 2018-present, Evgeny Nadymov\n *\n * This source code is licensed under the GPL v.3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */import React from'react';import classNames from'classnames';import SharedDocument from'../../Tile/SharedMedia/SharedDocument';import SharedMediaHeader from'./SharedMediaHeader';import{between,insertByOrder}from'../../../Utils/Common';import{loadMessageContents}from'../../../Utils/File';import{messageComparatorDesc}from'../../../Utils/Message';import{SHARED_MESSAGE_SLICE_LIMIT}from'../../../Constants';import FileStore from'../../../Stores/FileStore';import MessageStore from'../../../Stores/MessageStore';import TdLibController from'../../../Controllers/TdLibController';import'./SharedMediaBase.css';var SharedMediaBase=/*#__PURE__*/function(_React$Component){_inherits(SharedMediaBase,_React$Component);_createClass(SharedMediaBase,null,[{key:\"getStyles\",value:function getStyles(theme){return{sharedMediaList:{},sharedMediaSearchList:{background:theme.palette.type==='dark'?theme.palette.background.default:'#FFFFFF'}};}}]);function SharedMediaBase(props){var _this;_classCallCheck(this,SharedMediaBase);if((this instanceof SharedMediaBase?this.constructor:void 0)===SharedMediaBase){throw new TypeError('Cannot construct SharedMediaBase instances directly');}// console.log('SharedMediaBase.ctor');\n_this=_possibleConstructorReturn(this,_getPrototypeOf(SharedMediaBase).call(this,props));_this.onUpdateMessageContent=function(update){var _this$props=_this.props,chatId=_this$props.chatId,migratedChatId=_this$props.migratedChatId;var _this$state=_this.state,items=_this$state.items,migratedItems=_this$state.migratedItems;var chat_id=update.chat_id,message_id=update.message_id,old_content=update.old_content,new_content=update.new_content;var message=MessageStore.get(chat_id,message_id);// console.log(`SharedDocuments.onUpdateMessageContent chat_id=${chat_id} message_id=${message_id}`, this.state.items);\nif(chat_id===chatId){if(!items.length)return;if(!between(message_id,items[0].id,items[items.length-1].id,true))return;var index=items.findIndex(function(x){return x.id===message_id;});if(_this.isValidContent(new_content)){if(index===-1){// add new document\n_this.setState({items:insertByOrder(items,message,messageComparatorDesc)});}else{// replace document\n_this.setState({items:[].concat(_toConsumableArray(items.slice(0,index)),[message],_toConsumableArray(items.slice(index+1)))});}}else{if(index===-1){}else{// remove none document\n_this.setState({items:items.filter(function(x){return x.id!==message_id;})});}}}else if(chat_id===migratedChatId){if(!migratedItems.length)return;if(!between(message_id,migratedItems[0].id,migratedItems[migratedItems.length-1].id,true))return;var _index=migratedItems.findIndex(function(x){return x.id===message_id;});if(_this.isValidContent(new_content)){if(_index===-1){// add new document\n_this.setState({migratedItems:insertByOrder(migratedItems,message,messageComparatorDesc)});}else{// replace document\n_this.setState({migratedItems:[].concat(_toConsumableArray(migratedItems.slice(0,_index)),[message],_toConsumableArray(migratedItems.slice(_index+1)))});}}else{if(_index===-1){}else{// remove none document\n_this.setState({migratedItems:migratedItems.filter(function(x){return x.id!==message_id;})});}}}};_this.onUpdateNewMessage=function(update){var _this$props2=_this.props,chatId=_this$props2.chatId,migratedChatId=_this$props2.migratedChatId;var _this$state2=_this.state,items=_this$state2.items,migratedItems=_this$state2.migratedItems;var message=update.message;var chat_id=message.chat_id;if(chat_id!==chatId)return;if(!_this.isValidMessage(message))return;var store=FileStore.getStore();loadMessageContents(store,[message]);if(chat_id===chatId){_this.setState({items:[message].concat(items)});}else if(chat_id===migratedChatId){_this.setState({migratedItems:[message].concat(migratedItems)});}};_this.onUpdateDeleteMessages=function(update){var _this$props3=_this.props,chatId=_this$props3.chatId,migratedChatId=_this$props3.migratedChatId;var _this$state3=_this.state,items=_this$state3.items,migratedItems=_this$state3.migratedItems;var chat_id=update.chat_id,message_ids=update.message_ids;var map=new Map(message_ids.map(function(x){return[x,x];}));var callback=function callback(){if(_this.state.items.length+_this.state.migratedItems.length<SHARED_MESSAGE_SLICE_LIMIT){_this.onLoadNext(_this.params);}};if(chat_id===chatId){_this.setState({items:items.filter(function(x){return!map.has(x.id);})},callback);}else if(chat_id===migratedChatId){_this.setState({migratedItems:migratedItems.filter(function(x){return!map.has(x.id);})},callback);}};_this.loadContent=function(){_this.params={loading:false,completed:false,migrateCompleted:false,items:[],migratedItems:[],filter:_this.getSearchFilter()};_this.onLoadNext(_this.params);};_this.onLoadNext=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(params){var loadIncomplete,chatId,completed,filter,items,loading,fromMessageId,result,messages,incompleteResults,store,_args=arguments;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:loadIncomplete=_args.length>1&&_args[1]!==undefined?_args[1]:true;chatId=_this.props.chatId;completed=params.completed,filter=params.filter,items=params.items,loading=params.loading;// console.log('SharedMediaBase.onLoadNext', completed, loading);\nif(!loading){_context.next=5;break;}return _context.abrupt(\"return\");case 5:if(!completed){_context.next=7;break;}return _context.abrupt(\"return\");case 7:fromMessageId=items.length>0?items[items.length-1].id:0;params.loading=true;_context.next=11;return TdLibController.send({'@type':'searchChatMessages',chat_id:chatId,query:'',sender_user_id:0,from_message_id:fromMessageId,offset:0,limit:SHARED_MESSAGE_SLICE_LIMIT,filter:filter}).finally(function(){params.loading=false;});case 11:result=_context.sent;messages=result.messages;params.completed=messages.length===0||messages.total_count===0;params.items=items.concat(messages.filter(_this.isValidMessage));incompleteResults=loadIncomplete&&messages.length>0&&messages.length<SHARED_MESSAGE_SLICE_LIMIT;MessageStore.setItems(result.messages);store=FileStore.getStore();loadMessageContents(store,result.messages);_this.setState({items:params.items});if(params.completed){_this.onLoadMigratedNext(params,true);}else if(incompleteResults){_this.onLoadNext(params,false);}case 21:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}();_this.onLoadMigratedNext=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(params){var loadIncomplete,migratedChatId,filter,loading,migrateCompleted,items,fromMessageId,result,messages,incompleteResults,store,_args2=arguments;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:loadIncomplete=_args2.length>1&&_args2[1]!==undefined?_args2[1]:true;migratedChatId=_this.props.migratedChatId;filter=params.filter,loading=params.loading,migrateCompleted=params.migrateCompleted,items=params.migratedItems;// console.log('SharedMediaBase.onLoadMigratedNext', migratedChatId, loading, migrateCompleted);\nif(migratedChatId){_context2.next=5;break;}return _context2.abrupt(\"return\");case 5:if(!loading){_context2.next=7;break;}return _context2.abrupt(\"return\");case 7:if(!migrateCompleted){_context2.next=9;break;}return _context2.abrupt(\"return\");case 9:fromMessageId=items.length>0?items[items.length-1].id:0;params.loading=true;_context2.next=13;return TdLibController.send({'@type':'searchChatMessages',chat_id:migratedChatId,query:'',sender_user_id:0,from_message_id:fromMessageId,offset:0,limit:SHARED_MESSAGE_SLICE_LIMIT,filter:filter}).finally(function(){params.loading=false;});case 13:result=_context2.sent;messages=result.messages;params.migratedItems=items.concat(messages.filter(_this.isValidMessage));params.migrateCompleted=messages.length===0||messages.total_count===0;incompleteResults=loadIncomplete&&messages.length>0&&messages.length<SHARED_MESSAGE_SLICE_LIMIT;if(!params.migrateCompleted){_context2.next=20;break;}return _context2.abrupt(\"return\");case 20:MessageStore.setItems(messages);store=FileStore.getStore();loadMessageContents(store,messages);_this.setState({migratedItems:params.migratedItems});if(incompleteResults){_this.onLoadMigratedNext(params,false);}case 25:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x2){return _ref2.apply(this,arguments);};}();_this.handleScroll=function(){if(!_this.listRef)return;var list=_this.listRef.current;if(!list)return;var _assertThisInitialize=_assertThisInitialized(_this),params=_assertThisInitialize.params;if(list.scrollTop+list.offsetHeight>=list.scrollHeight){if(params&&!params.completed){_this.onLoadNext(params);}else{_this.onLoadMigratedNext(params);}}};_this.handleHeaderClick=function(){var list=_this.listRef.current;if(!list)return;list.scrollTop=0;};_this.handleSearchScroll=function(){if(!_this.searchListRef)return;var list=_this.searchListRef.current;if(!list)return;var _assertThisInitialize2=_assertThisInitialized(_this),searchParams=_assertThisInitialize2.searchParams;if(!searchParams)return;if(list.scrollTop+list.offsetHeight>=list.scrollHeight){if(!searchParams.completed){_this.onSearchNext(searchParams);}else{_this.onSearchMigratedNext(searchParams);}}};_this.onSearchNext=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(params){var loadIncomplete,chatId,completed,filter,items,loading,query,fromMessageId,result,messages,incompleteResults,store,_args3=arguments;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:loadIncomplete=_args3.length>1&&_args3[1]!==undefined?_args3[1]:true;chatId=_this.props.chatId;completed=params.completed,filter=params.filter,items=params.items,loading=params.loading,query=params.query;// console.log('SharedMediaBase.onSearchNext', completed, loading);\nif(!completed){_context3.next=5;break;}return _context3.abrupt(\"return\");case 5:if(!loading){_context3.next=7;break;}return _context3.abrupt(\"return\");case 7:fromMessageId=items.length>0?items[items.length-1].id:0;params.loading=true;_context3.next=11;return TdLibController.send({'@type':'searchChatMessages',chat_id:chatId,query:query,sender_user_id:0,from_message_id:fromMessageId,offset:0,limit:SHARED_MESSAGE_SLICE_LIMIT,filter:filter}).finally(function(){params.loading=false;});case 11:result=_context3.sent;messages=result.messages;params.items=items.concat(messages.filter(_this.isValidMessage));params.completed=messages.length===0||messages.total_count===0;incompleteResults=loadIncomplete&&messages.length>0&&messages.length<SHARED_MESSAGE_SLICE_LIMIT;if(!(_this.searchParams!==params)){_context3.next=18;break;}return _context3.abrupt(\"return\");case 18:MessageStore.setItems(messages);store=FileStore.getStore();loadMessageContents(store,messages);_this.setState({searchItems:params.items,searchMigratedItems:params.migratedItems});if(params.completed){_this.onSearchMigratedNext(params,true);}else if(incompleteResults){_this.onSearchNext(params,false);}case 23:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x3){return _ref3.apply(this,arguments);};}();_this.onSearchMigratedNext=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(params){var loadIncomplete,migratedChatId,filter,loading,items,migrateCompleted,query,fromMessageId,result,messages,incompleteResults,store,_args4=arguments;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:loadIncomplete=_args4.length>1&&_args4[1]!==undefined?_args4[1]:true;migratedChatId=_this.props.migratedChatId;filter=params.filter,loading=params.loading,items=params.migratedItems,migrateCompleted=params.migrateCompleted,query=params.query;// console.log('SharedMediaBase.onSearchMigratedNext', migratedChatId, loading, migrateCompleted);\nif(migratedChatId){_context4.next=5;break;}return _context4.abrupt(\"return\");case 5:if(!loading){_context4.next=7;break;}return _context4.abrupt(\"return\");case 7:if(!migrateCompleted){_context4.next=9;break;}return _context4.abrupt(\"return\");case 9:fromMessageId=items.length>0?items[items.length-1].id:0;params.loading=true;_context4.next=13;return TdLibController.send({'@type':'searchChatMessages',chat_id:migratedChatId,query:query,sender_user_id:0,from_message_id:fromMessageId,offset:0,limit:SHARED_MESSAGE_SLICE_LIMIT,filter:filter}).finally(function(){params.loading=false;});case 13:result=_context4.sent;messages=result.messages;params.migratedItems=items.concat(messages.filter(_this.isValidMessage));params.migrateCompleted=messages.length===0||messages.total_count===0;incompleteResults=loadIncomplete&&messages.length>0&&messages.length<SHARED_MESSAGE_SLICE_LIMIT;if(!(_this.searchParams!==params)){_context4.next=20;break;}return _context4.abrupt(\"return\");case 20:MessageStore.setItems(messages);store=FileStore.getStore();loadMessageContents(store,messages);_this.setState({searchItems:params.items,searchMigratedItems:params.migratedItems});if(incompleteResults){_this.onSearchMigratedNext(params,false);}case 25:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x4){return _ref4.apply(this,arguments);};}();_this.handleSearch=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(text){var query;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:query=text?text.trim():'';if(query){_context5.next=4;break;}_this.handleCloseSearch();return _context5.abrupt(\"return\");case 4:_this.searchParams={query:query,completed:false,migrateCompleted:false,items:[],migratedItems:[],filter:_this.getSearchFilter()};_this.onSearchNext(_this.searchParams,true);case 6:case\"end\":return _context5.stop();}}},_callee5);}));return function(_x5){return _ref5.apply(this,arguments);};}();_this.handleCloseSearch=function(){_this.searchParams=null;_this.setState({searchItems:[],searchMigratedItems:[]});};_this.isValidMessage=function(message){if(!message)return false;return _this.isValidContent(message.content);};_this.listRef=React.createRef();_this.searchListRef=React.createRef();_this.state={items:[],migratedItems:[],searchItems:[],searchMigratedItems:[]};return _this;}_createClass(SharedMediaBase,[{key:\"hasSearch\",value:function hasSearch(){return true;}},{key:\"isValidContent\",value:function isValidContent(content){throw new Error('Virtual method isValidContent is not implemented');}},{key:\"getItemTemplate\",value:function getItemTemplate(message){var migratedChatId=this.props.migratedChatId;var chat_id=message.chat_id,id=message.id;return React.createElement(SharedDocument,{key:\"chat_id=\".concat(chat_id,\"_message_id=\").concat(id),chatId:chat_id,messageId:id,showOpenMessage:chat_id!==migratedChatId});}},{key:\"getSearchFilter\",value:function getSearchFilter(){throw new Error('Virtual method getSearchFilter is not implemented');}},{key:\"getHeader\",value:function getHeader(){throw new Error('Virtual method getHeader is not implemented');}},{key:\"componentDidMount\",value:function componentDidMount(){this.loadContent();MessageStore.on('updateDeleteMessages',this.onUpdateDeleteMessages);MessageStore.on('updateMessageContent',this.onUpdateMessageContent);MessageStore.on('updateNewMessage',this.onUpdateNewMessage);}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){MessageStore.removeListener('updateDeleteMessages',this.onUpdateDeleteMessages);MessageStore.removeListener('updateMessageContent',this.onUpdateMessageContent);MessageStore.removeListener('updateNewMessage',this.onUpdateNewMessage);}},{key:\"render\",value:function render(){var _this2=this;var _this$props4=this.props,classes=_this$props4.classes,minHeight=_this$props4.minHeight,onClose=_this$props4.onClose,popup=_this$props4.popup;var _this$state4=this.state,items=_this$state4.items,migratedItems=_this$state4.migratedItems,searchItems=_this$state4.searchItems,searchMigratedItems=_this$state4.searchMigratedItems;var searchParams=this.searchParams;var messages=items.concat(migratedItems).map(function(x){return _this2.getItemTemplate(x);});var searchMessages=searchItems.concat(searchMigratedItems).map(function(x){return _this2.getItemTemplate(x);});console.log('SharedMediaBase.render',items,messages);return React.createElement(React.Fragment,null,React.createElement(SharedMediaHeader,{title:this.getHeader(),onClick:this.handleHeaderClick,onClose:onClose,onSearch:this.hasSearch()?this.handleSearch:null,onCloseSearch:this.handleCloseSearch}),React.createElement(\"div\",{ref:this.listRef,className:classNames('shared-media-list',classes.sharedMediaList),onScroll:this.handleScroll,style:{minHeight:popup?minHeight:null}},messages),Boolean(searchParams)&&React.createElement(\"div\",{ref:this.searchListRef,className:classNames('shared-media-search-list',classes.sharedMediaSearchList),onScroll:this.handleSearchScroll},searchMessages));}}]);return SharedMediaBase;}(React.Component);export default SharedMediaBase;","map":{"version":3,"sources":["/Users/yosuahalim/Documents/Projects/telegram-app/src/Components/ColumnRight/SharedMedia/SharedMediaBase.js"],"names":["React","classNames","SharedDocument","SharedMediaHeader","between","insertByOrder","loadMessageContents","messageComparatorDesc","SHARED_MESSAGE_SLICE_LIMIT","FileStore","MessageStore","TdLibController","SharedMediaBase","theme","sharedMediaList","sharedMediaSearchList","background","palette","type","default","props","TypeError","onUpdateMessageContent","update","chatId","migratedChatId","state","items","migratedItems","chat_id","message_id","old_content","new_content","message","get","length","id","index","findIndex","x","isValidContent","setState","slice","filter","onUpdateNewMessage","isValidMessage","store","getStore","concat","onUpdateDeleteMessages","message_ids","map","Map","callback","onLoadNext","params","has","loadContent","loading","completed","migrateCompleted","getSearchFilter","loadIncomplete","fromMessageId","send","query","sender_user_id","from_message_id","offset","limit","finally","result","messages","total_count","incompleteResults","setItems","onLoadMigratedNext","handleScroll","listRef","list","current","scrollTop","offsetHeight","scrollHeight","handleHeaderClick","handleSearchScroll","searchListRef","searchParams","onSearchNext","onSearchMigratedNext","searchItems","searchMigratedItems","handleSearch","text","trim","handleCloseSearch","content","createRef","Error","on","removeListener","classes","minHeight","onClose","popup","getItemTemplate","searchMessages","console","log","getHeader","hasSearch","Boolean","Component"],"mappings":"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","sourcesContent":["/*\n *  Copyright (c) 2018-present, Evgeny Nadymov\n *\n * This source code is licensed under the GPL v.3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport classNames from 'classnames';\nimport SharedDocument from '../../Tile/SharedMedia/SharedDocument';\nimport SharedMediaHeader from './SharedMediaHeader';\nimport { between, insertByOrder } from '../../../Utils/Common';\nimport { loadMessageContents } from '../../../Utils/File';\nimport { messageComparatorDesc } from '../../../Utils/Message';\nimport { SHARED_MESSAGE_SLICE_LIMIT } from '../../../Constants';\nimport FileStore from '../../../Stores/FileStore';\nimport MessageStore from '../../../Stores/MessageStore';\nimport TdLibController from '../../../Controllers/TdLibController';\nimport './SharedMediaBase.css';\n\nclass SharedMediaBase extends React.Component {\n    static getStyles(theme) {\n        return {\n            sharedMediaList: {},\n            sharedMediaSearchList: {\n                background: theme.palette.type === 'dark' ? theme.palette.background.default : '#FFFFFF'\n            }\n        };\n    }\n\n    constructor(props) {\n        if (new.target === SharedMediaBase) {\n            throw new TypeError('Cannot construct SharedMediaBase instances directly');\n        }\n\n        // console.log('SharedMediaBase.ctor');\n\n        super(props);\n\n        this.listRef = React.createRef();\n        this.searchListRef = React.createRef();\n\n        this.state = {\n            items: [],\n            migratedItems: [],\n            searchItems: [],\n            searchMigratedItems: []\n        };\n    }\n\n    hasSearch() {\n        return true;\n    }\n\n    isValidContent(content) {\n        throw new Error('Virtual method isValidContent is not implemented');\n    }\n\n    getItemTemplate(message) {\n        const { migratedChatId } = this.props;\n        const { chat_id, id } = message;\n\n        return (\n            <SharedDocument\n                key={`chat_id=${chat_id}_message_id=${id}`}\n                chatId={chat_id}\n                messageId={id}\n                showOpenMessage={chat_id !== migratedChatId}\n            />\n        );\n    }\n\n    getSearchFilter() {\n        throw new Error('Virtual method getSearchFilter is not implemented');\n    }\n\n    getHeader() {\n        throw new Error('Virtual method getHeader is not implemented');\n    }\n\n    componentDidMount() {\n        this.loadContent();\n\n        MessageStore.on('updateDeleteMessages', this.onUpdateDeleteMessages);\n        MessageStore.on('updateMessageContent', this.onUpdateMessageContent);\n        MessageStore.on('updateNewMessage', this.onUpdateNewMessage);\n    }\n\n    componentWillUnmount() {\n        MessageStore.removeListener('updateDeleteMessages', this.onUpdateDeleteMessages);\n        MessageStore.removeListener('updateMessageContent', this.onUpdateMessageContent);\n        MessageStore.removeListener('updateNewMessage', this.onUpdateNewMessage);\n    }\n\n    onUpdateMessageContent = update => {\n        const { chatId, migratedChatId } = this.props;\n        const { items, migratedItems } = this.state;\n\n        const { chat_id, message_id, old_content, new_content } = update;\n\n        const message = MessageStore.get(chat_id, message_id);\n        // console.log(`SharedDocuments.onUpdateMessageContent chat_id=${chat_id} message_id=${message_id}`, this.state.items);\n\n        if (chat_id === chatId) {\n            if (!items.length) return;\n            if (!between(message_id, items[0].id, items[items.length - 1].id, true)) return;\n\n            const index = items.findIndex(x => x.id === message_id);\n            if (this.isValidContent(new_content)) {\n                if (index === -1) {\n                    // add new document\n                    this.setState({ items: insertByOrder(items, message, messageComparatorDesc) });\n                } else {\n                    // replace document\n                    this.setState({ items: [...items.slice(0, index), message, ...items.slice(index + 1)] });\n                }\n            } else {\n                if (index === -1) {\n                } else {\n                    // remove none document\n                    this.setState({ items: items.filter(x => x.id !== message_id) });\n                }\n            }\n        } else if (chat_id === migratedChatId) {\n            if (!migratedItems.length) return;\n            if (!between(message_id, migratedItems[0].id, migratedItems[migratedItems.length - 1].id, true)) return;\n\n            const index = migratedItems.findIndex(x => x.id === message_id);\n            if (this.isValidContent(new_content)) {\n                if (index === -1) {\n                    // add new document\n                    this.setState({\n                        migratedItems: insertByOrder(migratedItems, message, messageComparatorDesc)\n                    });\n                } else {\n                    // replace document\n                    this.setState({\n                        migratedItems: [...migratedItems.slice(0, index), message, ...migratedItems.slice(index + 1)]\n                    });\n                }\n            } else {\n                if (index === -1) {\n                } else {\n                    // remove none document\n                    this.setState({ migratedItems: migratedItems.filter(x => x.id !== message_id) });\n                }\n            }\n        }\n    };\n\n    onUpdateNewMessage = update => {\n        const { chatId, migratedChatId } = this.props;\n        const { items, migratedItems } = this.state;\n\n        const { message } = update;\n        const { chat_id } = message;\n\n        if (chat_id !== chatId) return;\n        if (!this.isValidMessage(message)) return;\n\n        const store = FileStore.getStore();\n        loadMessageContents(store, [message]);\n\n        if (chat_id === chatId) {\n            this.setState({ items: [message].concat(items) });\n        } else if (chat_id === migratedChatId) {\n            this.setState({ migratedItems: [message].concat(migratedItems) });\n        }\n    };\n\n    onUpdateDeleteMessages = update => {\n        const { chatId, migratedChatId } = this.props;\n        const { items, migratedItems } = this.state;\n\n        const { chat_id, message_ids } = update;\n\n        const map = new Map(message_ids.map(x => [x, x]));\n        const callback = () => {\n            if (this.state.items.length + this.state.migratedItems.length < SHARED_MESSAGE_SLICE_LIMIT) {\n                this.onLoadNext(this.params);\n            }\n        };\n\n        if (chat_id === chatId) {\n            this.setState({ items: items.filter(x => !map.has(x.id)) }, callback);\n        } else if (chat_id === migratedChatId) {\n            this.setState({ migratedItems: migratedItems.filter(x => !map.has(x.id)) }, callback);\n        }\n    };\n\n    loadContent = () => {\n        this.params = {\n            loading: false,\n            completed: false,\n            migrateCompleted: false,\n            items: [],\n            migratedItems: [],\n            filter: this.getSearchFilter()\n        };\n        this.onLoadNext(this.params);\n    };\n\n    onLoadNext = async (params, loadIncomplete = true) => {\n        const { chatId } = this.props;\n        const { completed, filter, items, loading } = params;\n\n        // console.log('SharedMediaBase.onLoadNext', completed, loading);\n\n        if (loading) return;\n        if (completed) return;\n\n        const fromMessageId = items.length > 0 ? items[items.length - 1].id : 0;\n        params.loading = true;\n        const result = await TdLibController.send({\n            '@type': 'searchChatMessages',\n            chat_id: chatId,\n            query: '',\n            sender_user_id: 0,\n            from_message_id: fromMessageId,\n            offset: 0,\n            limit: SHARED_MESSAGE_SLICE_LIMIT,\n            filter\n        }).finally(() => {\n            params.loading = false;\n        });\n\n        const { messages } = result;\n        params.completed = messages.length === 0 || messages.total_count === 0;\n        params.items = items.concat(messages.filter(this.isValidMessage));\n        const incompleteResults = loadIncomplete && messages.length > 0 && messages.length < SHARED_MESSAGE_SLICE_LIMIT;\n\n        MessageStore.setItems(result.messages);\n        const store = FileStore.getStore();\n        loadMessageContents(store, result.messages);\n\n        this.setState({ items: params.items });\n\n        if (params.completed) {\n            this.onLoadMigratedNext(params, true);\n        } else if (incompleteResults) {\n            this.onLoadNext(params, false);\n        }\n    };\n\n    onLoadMigratedNext = async (params, loadIncomplete = true) => {\n        const { migratedChatId } = this.props;\n        const { filter, loading, migrateCompleted, migratedItems: items } = params;\n\n        // console.log('SharedMediaBase.onLoadMigratedNext', migratedChatId, loading, migrateCompleted);\n\n        if (!migratedChatId) return;\n        if (loading) return;\n        if (migrateCompleted) return;\n\n        const fromMessageId = items.length > 0 ? items[items.length - 1].id : 0;\n        params.loading = true;\n        const result = await TdLibController.send({\n            '@type': 'searchChatMessages',\n            chat_id: migratedChatId,\n            query: '',\n            sender_user_id: 0,\n            from_message_id: fromMessageId,\n            offset: 0,\n            limit: SHARED_MESSAGE_SLICE_LIMIT,\n            filter\n        }).finally(() => {\n            params.loading = false;\n        });\n\n        const { messages } = result;\n        params.migratedItems = items.concat(messages.filter(this.isValidMessage));\n        params.migrateCompleted = messages.length === 0 || messages.total_count === 0;\n        const incompleteResults = loadIncomplete && messages.length > 0 && messages.length < SHARED_MESSAGE_SLICE_LIMIT;\n\n        if (params.migrateCompleted) return;\n\n        MessageStore.setItems(messages);\n        const store = FileStore.getStore();\n        loadMessageContents(store, messages);\n\n        this.setState({ migratedItems: params.migratedItems });\n\n        if (incompleteResults) {\n            this.onLoadMigratedNext(params, false);\n        }\n    };\n\n    handleScroll = () => {\n        if (!this.listRef) return;\n\n        const list = this.listRef.current;\n        if (!list) return;\n\n        const { params } = this;\n\n        if (list.scrollTop + list.offsetHeight >= list.scrollHeight) {\n            if (params && !params.completed) {\n                this.onLoadNext(params);\n            } else {\n                this.onLoadMigratedNext(params);\n            }\n        }\n    };\n\n    handleHeaderClick = () => {\n        const list = this.listRef.current;\n        if (!list) return;\n\n        list.scrollTop = 0;\n    };\n\n    handleSearchScroll = () => {\n        if (!this.searchListRef) return;\n\n        const list = this.searchListRef.current;\n        if (!list) return;\n\n        const { searchParams } = this;\n        if (!searchParams) return;\n\n        if (list.scrollTop + list.offsetHeight >= list.scrollHeight) {\n            if (!searchParams.completed) {\n                this.onSearchNext(searchParams);\n            } else {\n                this.onSearchMigratedNext(searchParams);\n            }\n        }\n    };\n\n    onSearchNext = async (params, loadIncomplete = true) => {\n        const { chatId } = this.props;\n        const { completed, filter, items, loading, query } = params;\n\n        // console.log('SharedMediaBase.onSearchNext', completed, loading);\n\n        if (completed) return;\n        if (loading) return;\n\n        const fromMessageId = items.length > 0 ? items[items.length - 1].id : 0;\n        params.loading = true;\n        const result = await TdLibController.send({\n            '@type': 'searchChatMessages',\n            chat_id: chatId,\n            query,\n            sender_user_id: 0,\n            from_message_id: fromMessageId,\n            offset: 0,\n            limit: SHARED_MESSAGE_SLICE_LIMIT,\n            filter\n        }).finally(() => {\n            params.loading = false;\n        });\n\n        const { messages } = result;\n        params.items = items.concat(messages.filter(this.isValidMessage));\n        params.completed = messages.length === 0 || messages.total_count === 0;\n        const incompleteResults = loadIncomplete && messages.length > 0 && messages.length < SHARED_MESSAGE_SLICE_LIMIT;\n\n        if (this.searchParams !== params) return;\n\n        MessageStore.setItems(messages);\n        const store = FileStore.getStore();\n        loadMessageContents(store, messages);\n\n        this.setState({ searchItems: params.items, searchMigratedItems: params.migratedItems });\n\n        if (params.completed) {\n            this.onSearchMigratedNext(params, true);\n        } else if (incompleteResults) {\n            this.onSearchNext(params, false);\n        }\n    };\n\n    onSearchMigratedNext = async (params, loadIncomplete = true) => {\n        const { migratedChatId } = this.props;\n        const { filter, loading, migratedItems: items, migrateCompleted, query } = params;\n\n        // console.log('SharedMediaBase.onSearchMigratedNext', migratedChatId, loading, migrateCompleted);\n\n        if (!migratedChatId) return;\n        if (loading) return;\n        if (migrateCompleted) return;\n\n        const fromMessageId = items.length > 0 ? items[items.length - 1].id : 0;\n        params.loading = true;\n        const result = await TdLibController.send({\n            '@type': 'searchChatMessages',\n            chat_id: migratedChatId,\n            query,\n            sender_user_id: 0,\n            from_message_id: fromMessageId,\n            offset: 0,\n            limit: SHARED_MESSAGE_SLICE_LIMIT,\n            filter\n        }).finally(() => {\n            params.loading = false;\n        });\n\n        const { messages } = result;\n        params.migratedItems = items.concat(messages.filter(this.isValidMessage));\n        params.migrateCompleted = messages.length === 0 || messages.total_count === 0;\n        const incompleteResults = loadIncomplete && messages.length > 0 && messages.length < SHARED_MESSAGE_SLICE_LIMIT;\n\n        if (this.searchParams !== params) return;\n\n        MessageStore.setItems(messages);\n        const store = FileStore.getStore();\n        loadMessageContents(store, messages);\n\n        this.setState({ searchItems: params.items, searchMigratedItems: params.migratedItems });\n\n        if (incompleteResults) {\n            this.onSearchMigratedNext(params, false);\n        }\n    };\n\n    handleSearch = async text => {\n        const query = text ? text.trim() : '';\n        if (!query) {\n            this.handleCloseSearch();\n            return;\n        }\n\n        this.searchParams = {\n            query,\n            completed: false,\n            migrateCompleted: false,\n            items: [],\n            migratedItems: [],\n            filter: this.getSearchFilter()\n        };\n        this.onSearchNext(this.searchParams, true);\n    };\n\n    handleCloseSearch = () => {\n        this.searchParams = null;\n        this.setState({ searchItems: [], searchMigratedItems: [] });\n    };\n\n    isValidMessage = message => {\n        if (!message) return false;\n\n        return this.isValidContent(message.content);\n    };\n\n    render() {\n        const { classes, minHeight, onClose, popup } = this.props;\n        const { items, migratedItems, searchItems, searchMigratedItems } = this.state;\n        const { searchParams } = this;\n\n        const messages = items.concat(migratedItems).map(x => this.getItemTemplate(x));\n        const searchMessages = searchItems.concat(searchMigratedItems).map(x => this.getItemTemplate(x));\n\n        console.log('SharedMediaBase.render', items, messages);\n\n        return (\n            <>\n                <SharedMediaHeader\n                    title={this.getHeader()}\n                    onClick={this.handleHeaderClick}\n                    onClose={onClose}\n                    onSearch={this.hasSearch() ? this.handleSearch : null}\n                    onCloseSearch={this.handleCloseSearch}\n                />\n                <div\n                    ref={this.listRef}\n                    className={classNames('shared-media-list', classes.sharedMediaList)}\n                    onScroll={this.handleScroll}\n                    style={{ minHeight: popup ? minHeight : null }}>\n                    {messages}\n                </div>\n                {Boolean(searchParams) && (\n                    <div\n                        ref={this.searchListRef}\n                        className={classNames('shared-media-search-list', classes.sharedMediaSearchList)}\n                        onScroll={this.handleSearchScroll}>\n                        {searchMessages}\n                    </div>\n                )}\n            </>\n        );\n    }\n}\n\nSharedMediaBase.propTypes = {};\n\nexport default SharedMediaBase;\n"]},"metadata":{},"sourceType":"module"}