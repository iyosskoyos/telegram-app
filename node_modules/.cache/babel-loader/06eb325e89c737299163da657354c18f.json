{"ast":null,"code":"import _slicedToArray from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _regeneratorRuntime from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _possibleConstructorReturn from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";import _inherits from\"/Users/yosuahalim/Documents/Projects/telegram-app/node_modules/@babel/runtime/helpers/esm/inherits\";/*\n *  Copyright (c) 2018-present, Evgeny Nadymov\n *\n * This source code is licensed under the GPL v.3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */import React from'react';import classNames from'classnames';import{withTranslation}from'react-i18next';import Button from'@material-ui/core/Button';import Checkbox from'@material-ui/core/Checkbox';import CloseIcon from'@material-ui/icons/Close';import DeleteIcon from'@material-ui/icons/Delete';import Dialog from'@material-ui/core/Dialog';import DialogActions from'@material-ui/core/DialogActions';import DialogContent from'@material-ui/core/DialogContent';import DialogContentText from'@material-ui/core/DialogContentText';import DialogTitle from'@material-ui/core/DialogTitle';import FormControlLabel from'@material-ui/core/FormControlLabel';import NavigateNextIcon from'@material-ui/icons/NavigateNext';import NavigateBeforeIcon from'@material-ui/icons/NavigateBefore';import ReplyIcon from'@material-ui/icons/Reply';import InvertColorsIcon from'@material-ui/icons/InvertColors';import SlowMotionVideoIcon from'@material-ui/icons/SlowMotionVideo';import MediaViewerControl from'../Tile/MediaViewerControl';import MediaViewerContent from'./MediaViewerContent';import MediaViewerButton from'./MediaViewerButton';import MediaViewerFooterText from'./MediaViewerFooterText';import MediaViewerFooterButton from'./MediaViewerFooterButton';import MediaViewerDownloadButton from'./MediaViewerDownloadButton';import{setMediaViewerContent}from'../../Actions/Client';import{getSize}from'../../Utils/Common';import{cancelPreloadMediaViewerContent,getMediaFile,loadMediaViewerContent,preloadMediaViewerContent,saveMedia}from'../../Utils/File';import{filterDuplicateMessages,isAnimationMessage,isLottieMessage,isMediaContent,isVideoMessage}from'../../Utils/Message';import{between}from'../../Utils/Common';import{PHOTO_BIG_SIZE,MEDIA_SLICE_LIMIT}from'../../Constants';import MessageStore from'../../Stores/MessageStore';import TdLibController from'../../Controllers/TdLibController';import'./MediaViewer.css';var forwardIconStyle={padding:20,transform:'scaleX(-1)'};var iconStyle={padding:20};var MediaViewer=/*#__PURE__*/function(_React$Component){_inherits(MediaViewer,_React$Component);function MediaViewer(props){var _this;_classCallCheck(this,MediaViewer);_this=_possibleConstructorReturn(this,_getPrototypeOf(MediaViewer).call(this,props));_this.onKeyDown=function(event){if(event.keyCode===27){var deleteConfirmationOpened=_this.state.deleteConfirmationOpened;if(deleteConfirmationOpened)return;_this.handleClose();}else if(event.keyCode===39){_this.handleNext();}else if(event.keyCode===37){_this.handlePrevious();}};_this.onUpdateMessageContent=function(update){var chat_id=update.chat_id,message_id=update.message_id,new_content=update.new_content,old_content=update.old_content;var chatId=_this.props.chatId;var _this$state=_this.state,currentMessageId=_this$state.currentMessageId,totalCount=_this$state.totalCount;if(chatId!==chat_id)return;var message=MessageStore.get(chat_id,message_id);if(!message)return;loadMediaViewerContent([message]);var addMessage=isMediaContent(new_content)&&!isMediaContent(old_content);if(addMessage){if(_this.history.length>=2&&(_this.firstSliceLoaded||between(message_id,_this.history[0].id,_this.history[_this.history.length-1].id))){var inserted=false;var history=[];for(var i=0;i<_this.history.length;i++){if(_this.history[i].id>message_id){history.push(_this.history[i]);}else{if(!inserted){inserted=true;history.push(message);}history.push(_this.history[i]);}}_this.history=history;}var index=_this.history.findIndex(function(x){return x.id===currentMessageId;});_this.setState({hasNextMedia:_this.hasNextMedia(index),hasPreviousMedia:_this.hasPreviousMedia(index),totalCount:totalCount+1});}var removeMessage=!isMediaContent(new_content)&&isMediaContent(old_content);if(removeMessage){var oldHistory=_this.history;_this.history=_this.history.filter(function(x){return x.id!==message_id;});if(currentMessageId===message_id){var filterMap=new Map();filterMap.set(message_id,message_id);_this.moveToNextMedia(oldHistory,filterMap);_this.setState({totalCount:Math.max(totalCount-1,0)});}else{var _index=_this.history.findIndex(function(x){return x.id===currentMessageId;});_this.setState({hasNextMedia:_this.hasNextMedia(_index),hasPreviousMedia:_this.hasPreviousMedia(_index),totalCount:Math.max(totalCount-1,0)});}}};_this.onUpdateDeleteMessages=function(update){var chat_id=update.chat_id,message_ids=update.message_ids,is_permanent=update.is_permanent;var chatId=_this.props.chatId;var _this$state2=_this.state,currentMessageId=_this$state2.currentMessageId,totalCount=_this$state2.totalCount;if(!is_permanent)return;if(chatId!==chat_id)return;var filterMap=message_ids.reduce(function(accumulator,currentId){accumulator.set(currentId,currentId);return accumulator;},new Map());var oldHistory=_this.history;var deletedCount=oldHistory.length;_this.history=_this.history.filter(function(x){return!filterMap.has(x.id);});deletedCount-=_this.history.length;_this.setState({totalCount:Math.max(totalCount-deletedCount,0)});if(!_this.history.length){setMediaViewerContent(null);return;}if(filterMap.has(currentMessageId)){_this.moveToNextMedia(oldHistory,filterMap);}};_this.onUpdateNewMessage=function(update){var chatId=_this.props.chatId;var _this$state3=_this.state,currentMessageId=_this$state3.currentMessageId,totalCount=_this$state3.totalCount;var message=update.message;if(!message)return;if(!isMediaContent(message.content))return;if(message.chat_id!==chatId)return;if(!_this.firstSliceLoaded)return;_this.history=[message].concat(_this.history);var index=_this.history.findIndex(function(x){return x.id===currentMessageId;});_this.setState({hasNextMedia:_this.hasNextMedia(index),hasPreviousMedia:_this.hasPreviousMedia(index),totalCount:totalCount+1});};_this.getFilter=function(chatId,messageId){var message=MessageStore.get(chatId,messageId);if(!message)return null;var content=message.content;if(!content)return null;switch(content['@type']){case'messageChatChangePhoto':{return{'@type':'searchMessagesFilterChatPhoto'};}case'messagePhoto':{return{'@type':'searchMessagesFilterPhotoAndVideo'};}case'messageVideo':{return{'@type':'searchMessagesFilterPhotoAndVideo'};}default:{return null;}}};_this.loadHistory=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _this$props,chatId,messageId,filter,result,currentMessageId,index,_filter,maxCount,count,_loop;return _regeneratorRuntime.wrap(function _callee$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_this$props=_this.props,chatId=_this$props.chatId,messageId=_this$props.messageId;filter=_this.getFilter(chatId,messageId);result={'@type':'messages',messages:[],total_count:0};if(!filter){_context2.next=7;break;}_context2.next=6;return TdLibController.send({'@type':'searchChatMessages',chat_id:chatId,query:'',sender_user_id:0,from_message_id:messageId,offset:-MEDIA_SLICE_LIMIT,limit:2*MEDIA_SLICE_LIMIT,filter:filter});case 6:result=_context2.sent;case 7:filterDuplicateMessages(result,_this.history);MessageStore.setItems(result.messages);_this.history=result.messages;_this.firstSliceLoaded=result.messages.length===0;currentMessageId=_this.state.currentMessageId;index=_this.history.findIndex(function(x){return x.id===currentMessageId;});_this.setState({hasNextMedia:_this.hasNextMedia(index),hasPreviousMedia:_this.hasPreviousMedia(index)});if(!(index===-1)){_context2.next=19;break;}_this.history=[MessageStore.get(chatId,currentMessageId)];preloadMediaViewerContent(0,_this.history);_context2.next=30;break;case 19:preloadMediaViewerContent(index,_this.history);_filter=_this.getFilter(chatId,messageId);if(_filter){_context2.next=23;break;}return _context2.abrupt(\"return\");case 23:maxCount=1500;count=0;_loop=/*#__PURE__*/_regeneratorRuntime.mark(function _loop(){var result,currentMessageId,index;return _regeneratorRuntime.wrap(function _loop$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return TdLibController.send({'@type':'searchChatMessages',chat_id:chatId,query:'',sender_user_id:0,from_message_id:_this.history.length>0?_this.history[0].id:0,offset:-99,limit:99+1,filter:_filter});case 2:result=_context.sent;count+=result.messages.length;filterDuplicateMessages(result,_this.history);MessageStore.setItems(result.messages);_this.history=result.messages.concat(_this.history);_this.firstSliceLoaded=result.messages.length===0;currentMessageId=_this.state.currentMessageId;index=_this.history.findIndex(function(x){return x.id===currentMessageId;});_this.setState({hasNextMedia:_this.hasNextMedia(index),hasPreviousMedia:_this.hasPreviousMedia(index),firstSliceLoaded:_this.firstSliceLoaded,totalCount:result.total_count});case 11:case\"end\":return _context.stop();}}},_loop);});case 26:if(!(!_this.firstSliceLoaded&&count<maxCount)){_context2.next=30;break;}return _context2.delegateYield(_loop(),\"t0\",28);case 28:_context2.next=26;break;case 30:case\"end\":return _context2.stop();}}},_callee);}));_this.handleClose=function(){setMediaViewerContent(null);var currentMessageId=_this.state.currentMessageId;var index=_this.history.findIndex(function(x){return x.id===currentMessageId;});if(index!==-1){cancelPreloadMediaViewerContent(index,_this.history);}};_this.handleSave=function(){var chatId=_this.props.chatId;var currentMessageId=_this.state.currentMessageId;var message=MessageStore.get(chatId,currentMessageId);if(!message)return;var content=message.content;if(!content)return;var media=null;switch(content['@type']){case'messageAnimation':{var animation=content.animation;media=animation;break;}case'messageChatChangePhoto':{var photo=content.photo;media=photo;break;}case'messageDocument':{var _document=content.document;media=_document;break;}case'messagePhoto':{var _photo=content.photo;media=_photo;break;}case'messageText':{var web_page=content.web_page;if(!web_page)return;var _animation=web_page.animation,_document2=web_page.document,_photo2=web_page.photo,video=web_page.video;if(_animation){media=_animation;break;}if(_document2){media=_document2;break;}if(_photo2){media=_photo2;break;}if(video){media=video;break;}break;}case'messageVideo':{var _video=content.video;media=_video;break;}}saveMedia(media,message);};_this.handleForward=function(){var chatId=_this.props.chatId;var currentMessageId=_this.state.currentMessageId;TdLibController.clientUpdate({'@type':'clientUpdateForward',info:{chatId:chatId,messageIds:[currentMessageId]}});};_this.handleDelete=function(){_this.handleDialogOpen();};_this.hasPreviousMedia=function(index){if(index===-1)return false;var nextIndex=index+1;return nextIndex<_this.history.length;};_this.handlePrevious=function(event){if(event){event.stopPropagation();}var currentMessageId=_this.state.currentMessageId;var index=_this.history.findIndex(function(x){return x.id===currentMessageId;});var nextIndex=index+1;return _this.loadMedia(nextIndex,function(){if(nextIndex===_this.history.length-1){_this.loadPrevious();}});};_this.loadPrevious=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var _this$props2,chatId,messageId,currentMessageId,filter,result,index;return _regeneratorRuntime.wrap(function _callee2$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_this$props2=_this.props,chatId=_this$props2.chatId,messageId=_this$props2.messageId;currentMessageId=_this.state.currentMessageId;filter=_this.getFilter(chatId,messageId);result={'@type':'messages',messages:[],total_count:0};if(!filter){_context3.next=8;break;}_context3.next=7;return TdLibController.send({'@type':'searchChatMessages',chat_id:chatId,query:'',sender_user_id:0,from_message_id:currentMessageId,offset:0,limit:MEDIA_SLICE_LIMIT,filter:filter});case 7:result=_context3.sent;case 8:filterDuplicateMessages(result,_this.history);MessageStore.setItems(result.messages);_this.history=_this.history.concat(result.messages);index=_this.history.findIndex(function(x){return x.id===currentMessageId;});_this.setState({hasNextMedia:_this.hasNextMedia(index),hasPreviousMedia:_this.hasPreviousMedia(index),totalCount:result.total_count});case 13:case\"end\":return _context3.stop();}}},_callee2);}));_this.hasNextMedia=function(index){if(index===-1)return false;var nextIndex=index-1;return nextIndex>=0;};_this.handleNext=function(event){if(event){event.stopPropagation();}var currentMessageId=_this.state.currentMessageId;var index=_this.history.findIndex(function(x){return x.id===currentMessageId;});var nextIndex=index-1;return _this.loadMedia(nextIndex,function(){if(nextIndex===0){_this.loadNext();}});};_this.loadNext=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var _this$props3,chatId,messageId,currentMessageId,filter,result,index;return _regeneratorRuntime.wrap(function _callee3$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_this$props3=_this.props,chatId=_this$props3.chatId,messageId=_this$props3.messageId;currentMessageId=_this.state.currentMessageId;filter=_this.getFilter(chatId,messageId);result={'@type':'messages',messages:[],total_count:0};if(!filter){_context4.next=8;break;}_context4.next=7;return TdLibController.send({'@type':'searchChatMessages',chat_id:chatId,query:'',sender_user_id:0,from_message_id:currentMessageId,offset:-MEDIA_SLICE_LIMIT,limit:MEDIA_SLICE_LIMIT+1,filter:filter});case 7:result=_context4.sent;case 8:filterDuplicateMessages(result,_this.history);MessageStore.setItems(result.messages);_this.firstSliceLoaded=result.messages.length===0;_this.history=result.messages.concat(_this.history);index=_this.history.findIndex(function(x){return x.id===currentMessageId;});_this.setState({hasNextMedia:_this.hasNextMedia(index),hasPreviousMedia:_this.hasPreviousMedia(index),firstSliceLoaded:_this.firstSliceLoaded,totalCount:result.total_count});case 14:case\"end\":return _context4.stop();}}},_callee3);}));_this.loadMedia=function(index,callback){if(index<0)return false;if(index>=_this.history.length)return false;_this.setState({currentMessageId:_this.history[index].id,hasNextMedia:_this.hasNextMedia(index),hasPreviousMedia:_this.hasPreviousMedia(index)},callback);preloadMediaViewerContent(index,_this.history);return true;};_this.moveToNextMedia=function(oldHistory,filterMap){var currentMessageId=_this.state.currentMessageId;var index=oldHistory.findIndex(function(x){return x.id===currentMessageId;});var nextId=0;for(var i=index-1;i>=0;i--){if(filterMap&&!filterMap.has(oldHistory[i].id)){nextId=oldHistory[i].id;break;}}if(!nextId){for(var _i=index+1;_i<oldHistory.length;_i++){if(filterMap&&!filterMap.has(oldHistory[_i].id)){nextId=oldHistory[_i].id;break;}}}if(!nextId)return;var nextIndex=_this.history.findIndex(function(x){return x.id===nextId;});return _this.loadMedia(nextIndex,function(){if(nextIndex===0){_this.loadNext();}else if(nextIndex===_this.history.length-1){_this.loadPrevious();}});};_this.handleDialogOpen=function(){_this.setState({deleteConfirmationOpened:true});};_this.handleDialogClose=function(){_this.setState({deleteConfirmationOpened:false});};_this.handleDone=function(){_this.setState({deleteConfirmationOpened:false});var chatId=_this.props.chatId;var _this$state4=_this.state,currentMessageId=_this$state4.currentMessageId,deleteForAll=_this$state4.deleteForAll;var message=MessageStore.get(chatId,currentMessageId);if(!message)return;var can_be_deleted_only_for_self=message.can_be_deleted_only_for_self,can_be_deleted_for_all_users=message.can_be_deleted_for_all_users;var canBeDeleted=can_be_deleted_only_for_self||can_be_deleted_for_all_users;if(!canBeDeleted)return;TdLibController.send({'@type':'deleteMessages',chat_id:chatId,message_ids:[currentMessageId],revoke:can_be_deleted_for_all_users&&deleteForAll});};_this.handleChangeDeleteForAll=function(event){_this.setState({deleteForAll:event.target.checked});};_this.handleInvertColors=function(){var background=_this.state.background;var nextBackground='media-viewer-default';switch(background){case'media-viewer-default':{nextBackground='media-viewer-dark';break;}case'media-viewer-dark':{nextBackground='media-viewer-light';break;}case'media-viewer-light':{nextBackground='media-viewer-default';break;}}_this.setState({background:nextBackground});};_this.handleChangeSpeed=function(){if(!_this.contentRef)return;var current=_this.contentRef.current;if(!current)return;var speed=_this.state.speed;var nextSpeed=speed<1?1:0.1;_this.setState({speed:nextSpeed});current.changeSpeed(nextSpeed);};_this.canBeForwarded=function(chatId,messageId){var message=MessageStore.get(chatId,messageId);if(!message)return false;var can_be_forwarded=message.can_be_forwarded,content=message.content;if(!content)return false;switch(content['@type']){case'messageChatChangePhoto':{return true;}default:{return can_be_forwarded;}}};_this.contentRef=React.createRef();_this.history=[];var _this$props4=_this.props,_chatId=_this$props4.chatId,_messageId=_this$props4.messageId;_this.state={speed:1,background:'media-viewer-default',prevChatId:_chatId,prevMessageId:_messageId,currentMessageId:_messageId,hasNextMedia:false,hasPreviousMedia:false,deleteConfirmationOpened:false,deleteForAll:true};return _this;}_createClass(MediaViewer,[{key:\"shouldComponentUpdate\",value:function shouldComponentUpdate(nextProps,nextState){var _this$props5=this.props,chatId=_this$props5.chatId,messageId=_this$props5.messageId;var _this$state5=this.state,background=_this$state5.background,currentMessageId=_this$state5.currentMessageId,deleteConfirmationOpened=_this$state5.deleteConfirmationOpened,firstSliceLoaded=_this$state5.firstSliceLoaded,hasNextMedia=_this$state5.hasNextMedia,hasPreviousMedia=_this$state5.hasPreviousMedia,speed=_this$state5.speed,totalCount=_this$state5.totalCount;if(nextState.background!==background){return true;}if(nextProps.chatId!==chatId){return true;}if(nextProps.messageId!==messageId){return true;}if(nextState.currentMessageId!==currentMessageId){return true;}if(nextState.hasPrevousMedia!==hasPreviousMedia){return true;}if(nextState.hasNextMedia!==hasNextMedia){return true;}if(nextState.firstSliceLoaded!==firstSliceLoaded){return true;}if(nextState.totalCount!==totalCount){return true;}if(nextState.deleteConfirmationOpened!==deleteConfirmationOpened){return true;}if(nextState.speed!==speed){return true;}return false;}},{key:\"componentDidMount\",value:function componentDidMount(){this.loadHistory();document.addEventListener('keydown',this.onKeyDown,false);MessageStore.on('updateDeleteMessages',this.onUpdateDeleteMessages);MessageStore.on('updateNewMessage',this.onUpdateNewMessage);MessageStore.on('updateMessageContent',this.onUpdateMessageContent);}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){document.removeEventListener('keydown',this.onKeyDown,false);MessageStore.removeListener('updateDeleteMessages',this.onUpdateDeleteMessages);MessageStore.removeListener('updateNewMessage',this.onUpdateNewMessage);MessageStore.removeListener('updateMessageContent',this.onUpdateMessageContent);}},{key:\"render\",value:function render(){var _this$props6=this.props,chatId=_this$props6.chatId,t=_this$props6.t;var _this$state6=this.state,background=_this$state6.background,currentMessageId=_this$state6.currentMessageId,deleteConfirmationOpened=_this$state6.deleteConfirmationOpened,deleteForAll=_this$state6.deleteForAll,firstSliceLoaded=_this$state6.firstSliceLoaded,hasNextMedia=_this$state6.hasNextMedia,hasPreviousMedia=_this$state6.hasPreviousMedia,speed=_this$state6.speed,totalCount=_this$state6.totalCount;var index=-1;if(totalCount&&firstSliceLoaded){index=this.history.findIndex(function(x){return x.id===currentMessageId;});}var maxCount=Math.max(this.history.length,totalCount);var message=MessageStore.get(chatId,currentMessageId);var can_be_deleted_for_all_users=message.can_be_deleted_for_all_users,can_be_deleted_only_for_self=message.can_be_deleted_only_for_self;var canBeDeleted=can_be_deleted_for_all_users||can_be_deleted_only_for_self;var canBeForwarded=this.canBeForwarded(chatId,currentMessageId);var deleteConfirmationContent='';if(isVideoMessage(chatId,currentMessageId)){deleteConfirmationContent=t('AreYouSureDeleteVideo');}else if(isAnimationMessage(chatId,currentMessageId)){deleteConfirmationContent=t('AreYouSureDeleteGIF');}else{deleteConfirmationContent=t('AreYouSureDeletePhoto');}var deleteConfirmation=deleteConfirmationOpened?React.createElement(Dialog,{transitionDuration:0,open:deleteConfirmationOpened,onClose:this.handleDialogClose,\"aria-labelledby\":\"form-dialog-title\"},React.createElement(DialogTitle,{id:\"form-dialog-title\"},t('AppName')),React.createElement(DialogContent,null,React.createElement(DialogContentText,null,deleteConfirmationContent),can_be_deleted_for_all_users&&React.createElement(FormControlLabel,{label:t('DeleteForAll'),control:React.createElement(Checkbox,{color:\"primary\",value:\"deleteAll\",onChange:this.handleChangeDeleteForAll}),checked:deleteForAll})),React.createElement(DialogActions,null,React.createElement(Button,{onClick:this.handleDialogClose,color:\"primary\"},t('Cancel')),React.createElement(Button,{onClick:this.handleDone,color:\"primary\"},t('Ok')))):null;var _getMediaFile=getMediaFile(chatId,currentMessageId,PHOTO_BIG_SIZE),_getMediaFile2=_slicedToArray(_getMediaFile,3),width=_getMediaFile2[0],height=_getMediaFile2[1],file=_getMediaFile2[2];var fileId=file?file.id:0;var title=t('AttachPhoto');if(isVideoMessage(chatId,currentMessageId)){title=t('AttachVideo');}else if(isAnimationMessage(chatId,currentMessageId)){title=t('AttachGif');}else if(isLottieMessage(chatId,currentMessageId)){title='';}return React.createElement(\"div\",{className:classNames('media-viewer',background)},deleteConfirmation,React.createElement(\"div\",{className:\"media-viewer-wrapper\",onClick:this.handlePrevious},React.createElement(\"div\",{className:\"media-viewer-left-column\"},React.createElement(\"div\",{className:\"media-viewer-button-placeholder\"}),React.createElement(MediaViewerButton,{disabled:!hasPreviousMedia,grow:true,onClick:this.handlePrevious},React.createElement(NavigateBeforeIcon,{fontSize:\"large\"}))),React.createElement(\"div\",{className:\"media-viewer-content-column\"},React.createElement(MediaViewerContent,{ref:this.contentRef,chatId:chatId,messageId:currentMessageId,size:PHOTO_BIG_SIZE,onClick:this.handlePrevious})),React.createElement(\"div\",{className:\"media-viewer-right-column\"},React.createElement(MediaViewerButton,{onClick:this.handleClose},React.createElement(CloseIcon,{fontSize:\"large\"})),React.createElement(MediaViewerButton,{disabled:!hasNextMedia,grow:true,onClick:this.handleNext},React.createElement(NavigateNextIcon,{fontSize:\"large\"})))),React.createElement(\"div\",{className:\"media-viewer-footer\"},React.createElement(MediaViewerControl,{chatId:chatId,messageId:currentMessageId}),React.createElement(MediaViewerFooterText,{title:title,subtitle:maxCount&&index>=0?\"\".concat(maxCount-index,\" of \").concat(maxCount):null}),isLottieMessage(chatId,currentMessageId)&&React.createElement(React.Fragment,null,React.createElement(MediaViewerFooterButton,{title:t('ChangeSpeed'),checked:speed<1,onClick:this.handleChangeSpeed},React.createElement(SlowMotionVideoIcon,{style:iconStyle})),React.createElement(MediaViewerFooterButton,{title:t('InvertBackgroundColor'),onClick:this.handleInvertColors},React.createElement(InvertColorsIcon,{style:iconStyle}))),React.createElement(MediaViewerDownloadButton,{title:t('Save'),fileId:fileId,onClick:this.handleSave}),React.createElement(MediaViewerFooterButton,{title:t('Forward'),disabled:!canBeForwarded,onClick:this.handleForward},React.createElement(ReplyIcon,{style:forwardIconStyle})),React.createElement(MediaViewerFooterButton,{title:t('Delete'),disabled:!canBeDeleted,onClick:this.handleDelete},React.createElement(DeleteIcon,{style:iconStyle}))));}}]);return MediaViewer;}(React.Component);export default withTranslation()(MediaViewer);","map":{"version":3,"sources":["/Users/yosuahalim/Documents/Projects/telegram-app/src/Components/Viewer/MediaViewer.js"],"names":["React","classNames","withTranslation","Button","Checkbox","CloseIcon","DeleteIcon","Dialog","DialogActions","DialogContent","DialogContentText","DialogTitle","FormControlLabel","NavigateNextIcon","NavigateBeforeIcon","ReplyIcon","InvertColorsIcon","SlowMotionVideoIcon","MediaViewerControl","MediaViewerContent","MediaViewerButton","MediaViewerFooterText","MediaViewerFooterButton","MediaViewerDownloadButton","setMediaViewerContent","getSize","cancelPreloadMediaViewerContent","getMediaFile","loadMediaViewerContent","preloadMediaViewerContent","saveMedia","filterDuplicateMessages","isAnimationMessage","isLottieMessage","isMediaContent","isVideoMessage","between","PHOTO_BIG_SIZE","MEDIA_SLICE_LIMIT","MessageStore","TdLibController","forwardIconStyle","padding","transform","iconStyle","MediaViewer","props","onKeyDown","event","keyCode","deleteConfirmationOpened","state","handleClose","handleNext","handlePrevious","onUpdateMessageContent","update","chat_id","message_id","new_content","old_content","chatId","currentMessageId","totalCount","message","get","addMessage","history","length","firstSliceLoaded","id","inserted","i","push","index","findIndex","x","setState","hasNextMedia","hasPreviousMedia","removeMessage","oldHistory","filter","filterMap","Map","set","moveToNextMedia","Math","max","onUpdateDeleteMessages","message_ids","is_permanent","reduce","accumulator","currentId","deletedCount","has","onUpdateNewMessage","content","concat","getFilter","messageId","loadHistory","result","messages","total_count","send","query","sender_user_id","from_message_id","offset","limit","setItems","maxCount","count","handleSave","media","animation","photo","document","web_page","video","handleForward","clientUpdate","info","messageIds","handleDelete","handleDialogOpen","nextIndex","stopPropagation","loadMedia","loadPrevious","loadNext","callback","nextId","handleDialogClose","handleDone","deleteForAll","can_be_deleted_only_for_self","can_be_deleted_for_all_users","canBeDeleted","revoke","handleChangeDeleteForAll","target","checked","handleInvertColors","background","nextBackground","handleChangeSpeed","contentRef","current","speed","nextSpeed","changeSpeed","canBeForwarded","can_be_forwarded","createRef","prevChatId","prevMessageId","nextProps","nextState","hasPrevousMedia","addEventListener","on","removeEventListener","removeListener","t","deleteConfirmationContent","deleteConfirmation","width","height","file","fileId","title","Component"],"mappings":"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","sourcesContent":["/*\n *  Copyright (c) 2018-present, Evgeny Nadymov\n *\n * This source code is licensed under the GPL v.3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport classNames from 'classnames';\nimport { withTranslation } from 'react-i18next';\nimport Button from '@material-ui/core/Button';\nimport Checkbox from '@material-ui/core/Checkbox';\nimport CloseIcon from '@material-ui/icons/Close';\nimport DeleteIcon from '@material-ui/icons/Delete';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport DialogContent from '@material-ui/core/DialogContent';\nimport DialogContentText from '@material-ui/core/DialogContentText';\nimport DialogTitle from '@material-ui/core/DialogTitle';\nimport FormControlLabel from '@material-ui/core/FormControlLabel';\nimport NavigateNextIcon from '@material-ui/icons/NavigateNext';\nimport NavigateBeforeIcon from '@material-ui/icons/NavigateBefore';\nimport ReplyIcon from '@material-ui/icons/Reply';\nimport InvertColorsIcon from '@material-ui/icons/InvertColors';\nimport SlowMotionVideoIcon from '@material-ui/icons/SlowMotionVideo';\nimport MediaViewerControl from '../Tile/MediaViewerControl';\nimport MediaViewerContent from './MediaViewerContent';\nimport MediaViewerButton from './MediaViewerButton';\nimport MediaViewerFooterText from './MediaViewerFooterText';\nimport MediaViewerFooterButton from './MediaViewerFooterButton';\nimport MediaViewerDownloadButton from './MediaViewerDownloadButton';\nimport { setMediaViewerContent } from '../../Actions/Client';\nimport { getSize } from '../../Utils/Common';\nimport {\n    cancelPreloadMediaViewerContent,\n    getMediaFile,\n    loadMediaViewerContent,\n    preloadMediaViewerContent,\n    saveMedia\n} from '../../Utils/File';\nimport {\n    filterDuplicateMessages,\n    isAnimationMessage,\n    isLottieMessage,\n    isMediaContent,\n    isVideoMessage\n} from '../../Utils/Message';\nimport { between } from '../../Utils/Common';\nimport { PHOTO_BIG_SIZE, MEDIA_SLICE_LIMIT } from '../../Constants';\nimport MessageStore from '../../Stores/MessageStore';\nimport TdLibController from '../../Controllers/TdLibController';\nimport './MediaViewer.css';\n\nconst forwardIconStyle = {\n    padding: 20,\n    transform: 'scaleX(-1)'\n};\n\nconst iconStyle = {\n    padding: 20\n};\n\nclass MediaViewer extends React.Component {\n    constructor(props) {\n        super(props);\n\n        this.contentRef = React.createRef();\n        this.history = [];\n\n        const { chatId, messageId } = this.props;\n\n        this.state = {\n            speed: 1,\n            background: 'media-viewer-default',\n            prevChatId: chatId,\n            prevMessageId: messageId,\n            currentMessageId: messageId,\n            hasNextMedia: false,\n            hasPreviousMedia: false,\n            deleteConfirmationOpened: false,\n            deleteForAll: true\n        };\n    }\n\n    shouldComponentUpdate(nextProps, nextState) {\n        const { chatId, messageId } = this.props;\n        const {\n            background,\n            currentMessageId,\n            deleteConfirmationOpened,\n            firstSliceLoaded,\n            hasNextMedia,\n            hasPreviousMedia,\n            speed,\n            totalCount\n        } = this.state;\n\n        if (nextState.background !== background) {\n            return true;\n        }\n\n        if (nextProps.chatId !== chatId) {\n            return true;\n        }\n\n        if (nextProps.messageId !== messageId) {\n            return true;\n        }\n\n        if (nextState.currentMessageId !== currentMessageId) {\n            return true;\n        }\n\n        if (nextState.hasPrevousMedia !== hasPreviousMedia) {\n            return true;\n        }\n\n        if (nextState.hasNextMedia !== hasNextMedia) {\n            return true;\n        }\n\n        if (nextState.firstSliceLoaded !== firstSliceLoaded) {\n            return true;\n        }\n\n        if (nextState.totalCount !== totalCount) {\n            return true;\n        }\n\n        if (nextState.deleteConfirmationOpened !== deleteConfirmationOpened) {\n            return true;\n        }\n\n        if (nextState.speed !== speed) {\n            return true;\n        }\n\n        return false;\n    }\n\n    componentDidMount() {\n        this.loadHistory();\n\n        document.addEventListener('keydown', this.onKeyDown, false);\n        MessageStore.on('updateDeleteMessages', this.onUpdateDeleteMessages);\n        MessageStore.on('updateNewMessage', this.onUpdateNewMessage);\n        MessageStore.on('updateMessageContent', this.onUpdateMessageContent);\n    }\n\n    componentWillUnmount() {\n        document.removeEventListener('keydown', this.onKeyDown, false);\n        MessageStore.removeListener('updateDeleteMessages', this.onUpdateDeleteMessages);\n        MessageStore.removeListener('updateNewMessage', this.onUpdateNewMessage);\n        MessageStore.removeListener('updateMessageContent', this.onUpdateMessageContent);\n    }\n\n    onKeyDown = event => {\n        if (event.keyCode === 27) {\n            const { deleteConfirmationOpened } = this.state;\n            if (deleteConfirmationOpened) return;\n\n            this.handleClose();\n        } else if (event.keyCode === 39) {\n            this.handleNext();\n        } else if (event.keyCode === 37) {\n            this.handlePrevious();\n        }\n    };\n\n    onUpdateMessageContent = update => {\n        const { chat_id, message_id, new_content, old_content } = update;\n        const { chatId } = this.props;\n        const { currentMessageId, totalCount } = this.state;\n\n        if (chatId !== chat_id) return;\n\n        const message = MessageStore.get(chat_id, message_id);\n        if (!message) return;\n\n        loadMediaViewerContent([message]);\n\n        const addMessage = isMediaContent(new_content) && !isMediaContent(old_content);\n        if (addMessage) {\n            if (\n                this.history.length >= 2 &&\n                (this.firstSliceLoaded ||\n                    between(message_id, this.history[0].id, this.history[this.history.length - 1].id))\n            ) {\n                let inserted = false;\n                let history = [];\n                for (let i = 0; i < this.history.length; i++) {\n                    if (this.history[i].id > message_id) {\n                        history.push(this.history[i]);\n                    } else {\n                        if (!inserted) {\n                            inserted = true;\n                            history.push(message);\n                        }\n                        history.push(this.history[i]);\n                    }\n                }\n                this.history = history;\n            }\n\n            const index = this.history.findIndex(x => x.id === currentMessageId);\n            this.setState({\n                hasNextMedia: this.hasNextMedia(index),\n                hasPreviousMedia: this.hasPreviousMedia(index),\n                totalCount: totalCount + 1\n            });\n        }\n\n        const removeMessage = !isMediaContent(new_content) && isMediaContent(old_content);\n        if (removeMessage) {\n            let oldHistory = this.history;\n            this.history = this.history.filter(x => x.id !== message_id);\n\n            if (currentMessageId === message_id) {\n                const filterMap = new Map();\n                filterMap.set(message_id, message_id);\n\n                this.moveToNextMedia(oldHistory, filterMap);\n                this.setState({\n                    totalCount: Math.max(totalCount - 1, 0)\n                });\n            } else {\n                const index = this.history.findIndex(x => x.id === currentMessageId);\n                this.setState({\n                    hasNextMedia: this.hasNextMedia(index),\n                    hasPreviousMedia: this.hasPreviousMedia(index),\n                    totalCount: Math.max(totalCount - 1, 0)\n                });\n            }\n        }\n    };\n\n    onUpdateDeleteMessages = update => {\n        const { chat_id, message_ids, is_permanent } = update;\n        const { chatId } = this.props;\n        const { currentMessageId, totalCount } = this.state;\n\n        if (!is_permanent) return;\n        if (chatId !== chat_id) return;\n\n        const filterMap = message_ids.reduce((accumulator, currentId) => {\n            accumulator.set(currentId, currentId);\n            return accumulator;\n        }, new Map());\n\n        const oldHistory = this.history;\n        let deletedCount = oldHistory.length;\n\n        this.history = this.history.filter(x => !filterMap.has(x.id));\n        deletedCount -= this.history.length;\n\n        this.setState({ totalCount: Math.max(totalCount - deletedCount, 0) });\n\n        if (!this.history.length) {\n            setMediaViewerContent(null);\n            return;\n        }\n\n        if (filterMap.has(currentMessageId)) {\n            this.moveToNextMedia(oldHistory, filterMap);\n        }\n    };\n\n    onUpdateNewMessage = update => {\n        const { chatId } = this.props;\n        const { currentMessageId, totalCount } = this.state;\n\n        const { message } = update;\n        if (!message) return;\n        if (!isMediaContent(message.content)) return;\n\n        if (message.chat_id !== chatId) return;\n        if (!this.firstSliceLoaded) return;\n\n        this.history = [message].concat(this.history);\n        const index = this.history.findIndex(x => x.id === currentMessageId);\n\n        this.setState({\n            hasNextMedia: this.hasNextMedia(index),\n            hasPreviousMedia: this.hasPreviousMedia(index),\n            totalCount: totalCount + 1\n        });\n    };\n\n    getFilter = (chatId, messageId) => {\n        const message = MessageStore.get(chatId, messageId);\n        if (!message) return null;\n\n        const { content } = message;\n        if (!content) return null;\n\n        switch (content['@type']) {\n            case 'messageChatChangePhoto': {\n                return {\n                    '@type': 'searchMessagesFilterChatPhoto'\n                };\n            }\n            case 'messagePhoto': {\n                return {\n                    '@type': 'searchMessagesFilterPhotoAndVideo'\n                };\n            }\n            case 'messageVideo': {\n                return {\n                    '@type': 'searchMessagesFilterPhotoAndVideo'\n                };\n            }\n            default: {\n                return null;\n            }\n        }\n    };\n\n    loadHistory = async () => {\n        const { chatId, messageId } = this.props;\n\n        const filter = this.getFilter(chatId, messageId);\n\n        let result = {\n            '@type': 'messages',\n            messages: [],\n            total_count: 0\n        };\n        if (filter) {\n            result = await TdLibController.send({\n                '@type': 'searchChatMessages',\n                chat_id: chatId,\n                query: '',\n                sender_user_id: 0,\n                from_message_id: messageId,\n                offset: -MEDIA_SLICE_LIMIT,\n                limit: 2 * MEDIA_SLICE_LIMIT,\n                filter: filter\n            });\n        }\n\n        filterDuplicateMessages(result, this.history);\n        MessageStore.setItems(result.messages);\n\n        this.history = result.messages;\n        this.firstSliceLoaded = result.messages.length === 0;\n\n        const { currentMessageId } = this.state;\n        const index = this.history.findIndex(x => x.id === currentMessageId);\n\n        this.setState({\n            hasNextMedia: this.hasNextMedia(index),\n            hasPreviousMedia: this.hasPreviousMedia(index)\n        });\n\n        if (index === -1) {\n            this.history = [MessageStore.get(chatId, currentMessageId)];\n            preloadMediaViewerContent(0, this.history);\n        } else {\n            preloadMediaViewerContent(index, this.history);\n\n            const filter = this.getFilter(chatId, messageId);\n            if (!filter) return;\n\n            const maxCount = 1500;\n            let count = 0;\n            while (!this.firstSliceLoaded && count < maxCount) {\n                const result = await TdLibController.send({\n                    '@type': 'searchChatMessages',\n                    chat_id: chatId,\n                    query: '',\n                    sender_user_id: 0,\n                    from_message_id: this.history.length > 0 ? this.history[0].id : 0,\n                    offset: -99,\n                    limit: 99 + 1,\n                    filter: filter\n                });\n                count += result.messages.length;\n\n                filterDuplicateMessages(result, this.history);\n                MessageStore.setItems(result.messages);\n\n                this.history = result.messages.concat(this.history);\n                this.firstSliceLoaded = result.messages.length === 0;\n\n                const { currentMessageId } = this.state;\n                const index = this.history.findIndex(x => x.id === currentMessageId);\n\n                this.setState({\n                    hasNextMedia: this.hasNextMedia(index),\n                    hasPreviousMedia: this.hasPreviousMedia(index),\n                    firstSliceLoaded: this.firstSliceLoaded,\n                    totalCount: result.total_count\n                });\n            }\n        }\n    };\n\n    handleClose = () => {\n        setMediaViewerContent(null);\n\n        const { currentMessageId } = this.state;\n        const index = this.history.findIndex(x => x.id === currentMessageId);\n        if (index !== -1) {\n            cancelPreloadMediaViewerContent(index, this.history);\n        }\n    };\n\n    handleSave = () => {\n        const { chatId } = this.props;\n        const { currentMessageId } = this.state;\n\n        const message = MessageStore.get(chatId, currentMessageId);\n        if (!message) return;\n\n        const { content } = message;\n        if (!content) return;\n\n        let media = null;\n        switch (content['@type']) {\n            case 'messageAnimation': {\n                const { animation } = content;\n\n                media = animation;\n                break;\n            }\n            case 'messageChatChangePhoto': {\n                const { photo } = content;\n\n                media = photo;\n                break;\n            }\n            case 'messageDocument': {\n                const { document } = content;\n\n                media = document;\n                break;\n            }\n            case 'messagePhoto': {\n                const { photo } = content;\n\n                media = photo;\n                break;\n            }\n            case 'messageText': {\n                const { web_page } = content;\n                if (!web_page) return;\n\n                const { animation, document, photo, video } = web_page;\n\n                if (animation) {\n                    media = animation;\n                    break;\n                }\n\n                if (document) {\n                    media = document;\n                    break;\n                }\n\n                if (photo) {\n                    media = photo;\n                    break;\n                }\n\n                if (video) {\n                    media = video;\n                    break;\n                }\n                break;\n            }\n            case 'messageVideo': {\n                const { video } = content;\n\n                media = video;\n                break;\n            }\n        }\n\n        saveMedia(media, message);\n    };\n\n    handleForward = () => {\n        const { chatId } = this.props;\n        const { currentMessageId } = this.state;\n\n        TdLibController.clientUpdate({\n            '@type': 'clientUpdateForward',\n            info: {\n                chatId: chatId,\n                messageIds: [currentMessageId]\n            }\n        });\n    };\n\n    handleDelete = () => {\n        this.handleDialogOpen();\n    };\n\n    hasPreviousMedia = index => {\n        if (index === -1) return false;\n\n        const nextIndex = index + 1;\n        return nextIndex < this.history.length;\n    };\n\n    handlePrevious = event => {\n        if (event) {\n            event.stopPropagation();\n        }\n\n        const { currentMessageId } = this.state;\n        const index = this.history.findIndex(x => x.id === currentMessageId);\n        const nextIndex = index + 1;\n\n        return this.loadMedia(nextIndex, () => {\n            if (nextIndex === this.history.length - 1) {\n                this.loadPrevious();\n            }\n        });\n    };\n\n    loadPrevious = async () => {\n        const { chatId, messageId } = this.props;\n        const { currentMessageId } = this.state;\n\n        const filter = this.getFilter(chatId, messageId);\n\n        let result = {\n            '@type': 'messages',\n            messages: [],\n            total_count: 0\n        };\n        if (filter) {\n            result = await TdLibController.send({\n                '@type': 'searchChatMessages',\n                chat_id: chatId,\n                query: '',\n                sender_user_id: 0,\n                from_message_id: currentMessageId,\n                offset: 0,\n                limit: MEDIA_SLICE_LIMIT,\n                filter: filter\n            });\n        }\n\n        filterDuplicateMessages(result, this.history);\n        MessageStore.setItems(result.messages);\n\n        this.history = this.history.concat(result.messages);\n\n        const index = this.history.findIndex(x => x.id === currentMessageId);\n\n        this.setState({\n            hasNextMedia: this.hasNextMedia(index),\n            hasPreviousMedia: this.hasPreviousMedia(index),\n            totalCount: result.total_count\n        });\n    };\n\n    hasNextMedia = index => {\n        if (index === -1) return false;\n\n        const nextIndex = index - 1;\n        return nextIndex >= 0;\n    };\n\n    handleNext = event => {\n        if (event) {\n            event.stopPropagation();\n        }\n\n        const { currentMessageId } = this.state;\n        const index = this.history.findIndex(x => x.id === currentMessageId);\n        const nextIndex = index - 1;\n\n        return this.loadMedia(nextIndex, () => {\n            if (nextIndex === 0) {\n                this.loadNext();\n            }\n        });\n    };\n\n    loadNext = async () => {\n        const { chatId, messageId } = this.props;\n        const { currentMessageId } = this.state;\n\n        const filter = this.getFilter(chatId, messageId);\n\n        let result = {\n            '@type': 'messages',\n            messages: [],\n            total_count: 0\n        };\n        if (filter) {\n            result = await TdLibController.send({\n                '@type': 'searchChatMessages',\n                chat_id: chatId,\n                query: '',\n                sender_user_id: 0,\n                from_message_id: currentMessageId,\n                offset: -MEDIA_SLICE_LIMIT,\n                limit: MEDIA_SLICE_LIMIT + 1,\n                filter: filter\n            });\n        }\n\n        filterDuplicateMessages(result, this.history);\n        MessageStore.setItems(result.messages);\n\n        this.firstSliceLoaded = result.messages.length === 0;\n        this.history = result.messages.concat(this.history);\n\n        const index = this.history.findIndex(x => x.id === currentMessageId);\n\n        this.setState({\n            hasNextMedia: this.hasNextMedia(index),\n            hasPreviousMedia: this.hasPreviousMedia(index),\n            firstSliceLoaded: this.firstSliceLoaded,\n            totalCount: result.total_count\n        });\n    };\n\n    loadMedia = (index, callback) => {\n        if (index < 0) return false;\n        if (index >= this.history.length) return false;\n\n        this.setState(\n            {\n                currentMessageId: this.history[index].id,\n                hasNextMedia: this.hasNextMedia(index),\n                hasPreviousMedia: this.hasPreviousMedia(index)\n            },\n            callback\n        );\n\n        preloadMediaViewerContent(index, this.history);\n        return true;\n    };\n\n    moveToNextMedia = (oldHistory, filterMap) => {\n        const { currentMessageId } = this.state;\n\n        const index = oldHistory.findIndex(x => x.id === currentMessageId);\n        let nextId = 0;\n        for (let i = index - 1; i >= 0; i--) {\n            if (filterMap && !filterMap.has(oldHistory[i].id)) {\n                nextId = oldHistory[i].id;\n                break;\n            }\n        }\n        if (!nextId) {\n            for (let i = index + 1; i < oldHistory.length; i++) {\n                if (filterMap && !filterMap.has(oldHistory[i].id)) {\n                    nextId = oldHistory[i].id;\n                    break;\n                }\n            }\n        }\n\n        if (!nextId) return;\n\n        const nextIndex = this.history.findIndex(x => x.id === nextId);\n\n        return this.loadMedia(nextIndex, () => {\n            if (nextIndex === 0) {\n                this.loadNext();\n            } else if (nextIndex === this.history.length - 1) {\n                this.loadPrevious();\n            }\n        });\n    };\n\n    handleDialogOpen = () => {\n        this.setState({ deleteConfirmationOpened: true });\n    };\n\n    handleDialogClose = () => {\n        this.setState({ deleteConfirmationOpened: false });\n    };\n\n    handleDone = () => {\n        this.setState({ deleteConfirmationOpened: false });\n\n        const { chatId } = this.props;\n        const { currentMessageId, deleteForAll } = this.state;\n\n        const message = MessageStore.get(chatId, currentMessageId);\n        if (!message) return;\n\n        const { can_be_deleted_only_for_self, can_be_deleted_for_all_users } = message;\n        const canBeDeleted = can_be_deleted_only_for_self || can_be_deleted_for_all_users;\n        if (!canBeDeleted) return;\n\n        TdLibController.send({\n            '@type': 'deleteMessages',\n            chat_id: chatId,\n            message_ids: [currentMessageId],\n            revoke: can_be_deleted_for_all_users && deleteForAll\n        });\n    };\n\n    handleChangeDeleteForAll = event => {\n        this.setState({ deleteForAll: event.target.checked });\n    };\n\n    handleInvertColors = () => {\n        const { background } = this.state;\n\n        let nextBackground = 'media-viewer-default';\n        switch (background) {\n            case 'media-viewer-default': {\n                nextBackground = 'media-viewer-dark';\n                break;\n            }\n            case 'media-viewer-dark': {\n                nextBackground = 'media-viewer-light';\n                break;\n            }\n            case 'media-viewer-light': {\n                nextBackground = 'media-viewer-default';\n                break;\n            }\n        }\n\n        this.setState({\n            background: nextBackground\n        });\n    };\n\n    handleChangeSpeed = () => {\n        if (!this.contentRef) return;\n\n        const { current } = this.contentRef;\n        if (!current) return;\n\n        const { speed } = this.state;\n        const nextSpeed = speed < 1 ? 1 : 0.1;\n\n        this.setState({ speed: nextSpeed });\n\n        current.changeSpeed(nextSpeed);\n    };\n\n    canBeForwarded = (chatId, messageId) => {\n        const message = MessageStore.get(chatId, messageId);\n        if (!message) return false;\n\n        const { can_be_forwarded, content } = message;\n        if (!content) return false;\n\n        switch (content['@type']) {\n            case 'messageChatChangePhoto': {\n                return true;\n            }\n            default: {\n                return can_be_forwarded;\n            }\n        }\n    };\n\n    render() {\n        const { chatId, t } = this.props;\n        const {\n            background,\n            currentMessageId,\n            deleteConfirmationOpened,\n            deleteForAll,\n            firstSliceLoaded,\n            hasNextMedia,\n            hasPreviousMedia,\n            speed,\n            totalCount\n        } = this.state;\n\n        let index = -1;\n        if (totalCount && firstSliceLoaded) {\n            index = this.history.findIndex(x => x.id === currentMessageId);\n        }\n        const maxCount = Math.max(this.history.length, totalCount);\n\n        const message = MessageStore.get(chatId, currentMessageId);\n        const { can_be_deleted_for_all_users, can_be_deleted_only_for_self } = message;\n\n        const canBeDeleted = can_be_deleted_for_all_users || can_be_deleted_only_for_self;\n        const canBeForwarded = this.canBeForwarded(chatId, currentMessageId);\n\n        let deleteConfirmationContent = '';\n        if (isVideoMessage(chatId, currentMessageId)) {\n            deleteConfirmationContent = t('AreYouSureDeleteVideo');\n        } else if (isAnimationMessage(chatId, currentMessageId)) {\n            deleteConfirmationContent = t('AreYouSureDeleteGIF');\n        } else {\n            deleteConfirmationContent = t('AreYouSureDeletePhoto');\n        }\n        const deleteConfirmation = deleteConfirmationOpened ? (\n            <Dialog\n                transitionDuration={0}\n                open={deleteConfirmationOpened}\n                onClose={this.handleDialogClose}\n                aria-labelledby='form-dialog-title'>\n                <DialogTitle id='form-dialog-title'>{t('AppName')}</DialogTitle>\n                <DialogContent>\n                    <DialogContentText>{deleteConfirmationContent}</DialogContentText>\n                    {can_be_deleted_for_all_users && (\n                        <FormControlLabel\n                            label={t('DeleteForAll')}\n                            control={\n                                <Checkbox color='primary' value='deleteAll' onChange={this.handleChangeDeleteForAll} />\n                            }\n                            checked={deleteForAll}\n                        />\n                    )}\n                </DialogContent>\n                <DialogActions>\n                    <Button onClick={this.handleDialogClose} color='primary'>\n                        {t('Cancel')}\n                    </Button>\n                    <Button onClick={this.handleDone} color='primary'>\n                        {t('Ok')}\n                    </Button>\n                </DialogActions>\n            </Dialog>\n        ) : null;\n\n        const [width, height, file] = getMediaFile(chatId, currentMessageId, PHOTO_BIG_SIZE);\n\n        const fileId = file ? file.id : 0;\n        let title = t('AttachPhoto');\n        if (isVideoMessage(chatId, currentMessageId)) {\n            title = t('AttachVideo');\n        } else if (isAnimationMessage(chatId, currentMessageId)) {\n            title = t('AttachGif');\n        } else if (isLottieMessage(chatId, currentMessageId)) {\n            title = '';\n        }\n\n        return (\n            <div className={classNames('media-viewer', background)}>\n                {deleteConfirmation}\n                <div className='media-viewer-wrapper' onClick={this.handlePrevious}>\n                    <div className='media-viewer-left-column'>\n                        <div className='media-viewer-button-placeholder' />\n                        <MediaViewerButton disabled={!hasPreviousMedia} grow onClick={this.handlePrevious}>\n                            <NavigateBeforeIcon fontSize='large' />\n                        </MediaViewerButton>\n                    </div>\n\n                    <div className='media-viewer-content-column'>\n                        <MediaViewerContent\n                            ref={this.contentRef}\n                            chatId={chatId}\n                            messageId={currentMessageId}\n                            size={PHOTO_BIG_SIZE}\n                            onClick={this.handlePrevious}\n                        />\n                    </div>\n\n                    <div className='media-viewer-right-column'>\n                        <MediaViewerButton onClick={this.handleClose}>\n                            <CloseIcon fontSize='large' />\n                        </MediaViewerButton>\n                        <MediaViewerButton disabled={!hasNextMedia} grow onClick={this.handleNext}>\n                            <NavigateNextIcon fontSize='large' />\n                        </MediaViewerButton>\n                    </div>\n                </div>\n                <div className='media-viewer-footer'>\n                    <MediaViewerControl chatId={chatId} messageId={currentMessageId} />\n                    <MediaViewerFooterText\n                        title={title}\n                        subtitle={maxCount && index >= 0 ? `${maxCount - index} of ${maxCount}` : null}\n                    />\n                    {isLottieMessage(chatId, currentMessageId) && (\n                        <>\n                            <MediaViewerFooterButton\n                                title={t('ChangeSpeed')}\n                                checked={speed < 1}\n                                onClick={this.handleChangeSpeed}>\n                                <SlowMotionVideoIcon style={iconStyle} />\n                            </MediaViewerFooterButton>\n                            <MediaViewerFooterButton\n                                title={t('InvertBackgroundColor')}\n                                onClick={this.handleInvertColors}>\n                                <InvertColorsIcon style={iconStyle} />\n                            </MediaViewerFooterButton>\n                        </>\n                    )}\n                    <MediaViewerDownloadButton title={t('Save')} fileId={fileId} onClick={this.handleSave} />\n                    <MediaViewerFooterButton\n                        title={t('Forward')}\n                        disabled={!canBeForwarded}\n                        onClick={this.handleForward}>\n                        <ReplyIcon style={forwardIconStyle} />\n                    </MediaViewerFooterButton>\n                    <MediaViewerFooterButton title={t('Delete')} disabled={!canBeDeleted} onClick={this.handleDelete}>\n                        <DeleteIcon style={iconStyle} />\n                    </MediaViewerFooterButton>\n                </div>\n            </div>\n        );\n    }\n}\n\nMediaViewer.propTypes = {\n    chatId: PropTypes.number.isRequired,\n    messageId: PropTypes.number.isRequired\n};\n\nexport default withTranslation()(MediaViewer);\n"]},"metadata":{},"sourceType":"module"}